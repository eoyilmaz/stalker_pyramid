{#{% extends 'form_base.jinja2' %}#}
{#{% block form_block %}#}
<div class='dijitDialogPaneContentArea' style='height: 380px'>
  <form id='add_structure_form'>
    <table style='width: 100%'>
    
    {# Name #}
    <tr>
      <td class='label_column'>
        <label for='structure_name'>
          Name
        </label>
      </td>
      <td class='input_column'>
        <input id='structure_name'>
      </td>
    </tr>
    
    {# Custom Template #}
    <tr style='height: 260px'>
      <td class='label_column'>
        <label for='structure_custom_template'>
          Custom Template
        </label>
      </td>
      <td class='input_column'>
        <input id='structure_custom_template'>
      </td>
    </tr>
    
    {# Filename Templates #}
    <tr>
      <td class='label_column'>
        <label for='structure_filename_template'>
          Filename Templates
        </label>
      </td>
      <td class='input_column'>
        <select id='structure_filename_template'>
          {% for filename_template in filename_templates %}
            <option value='{{ filename_template.id }}'>
              {{ filename_template.name }} ({{ filename_template.target_entity_type }}, {{ filename_template.type.name }})
            </option>
          {% endfor %}
        </select>
      </td>
      <td class='button_column'>
        <button id='structure_add_filename_template_button'>Add</button>
{#          <button id='structure_edit_filename_template_button'>Edit</button>#}
      </td>
    </tr>
    </table>
  </form>
</div>

<div class='dijitDialogPaneActionBar'>
  <button id='structure_add_button'></button>
  <button id='structure_cancel_button'></button>
</div>

<script type='text/javascript'>
  require(['dijit/registry', 'dojo/_base/xhr', 'dojo/store/Memory',
    'dijit/form/Form', 'dijit/form/ValidationTextBox', 'dijit/form/TextBox',
    'dijit/form/SimpleTextarea', 'dijit/form/Button',
    'dijit/form/MultiSelect', 'dojo/domReady!'
  ],
    function(registry, xhr, Memory, Form, ValidationTextBox, TextBox,
             SimpleTextarea, Button, MultiSelect){
      
      // ********************************************************************
      // FORM
      var add_structure_form = new Form({
        id: 'add_structure_form',
        method: 'POST',
        onSubmit: function(event){
          if (this.validate()){
            // just close the dialog and somehow change the related field
            // on parent widget
            var deferred = xhr.post({
              content: {
                submitted: 'add'
              },
              url: '{{ request.route_url("add_structure") }}',
              form: dojo.byId('add_structure_form')
            });
            
            // update the caller dialog
            var dialog = dijit.byId('add_structure_dialog');
            var parent = dialog.get('parent');
            if (parent != null){
              // TODO: just update the structure field of the parent dialog
              parent.refresh()
            }
            
            // destroy the dialog
            dialog.destroyRecursive();
            
          }
          return false;
        }
      }, 'add_structure_form');
      add_structure_form.startup();
      
      // ********************************************************************
      // NAME
      var name_textBox = new ValidationTextBox({
        name: 'name',
        label: 'Name',
        placeHolder: 'Enter a name',
        required: true
      }, 'structure_name');
      name_textBox.startup();
      
      // ********************************************************************
      // CUSTOM TEMPLATE
      var custom_template_textarea = new SimpleTextarea({
        name: 'custom_template',
        label: 'Custom Template',
        placeHolder: 'Enter any custom template here',
        required: false,
        style: 'height: 250px; overflow:auto'
      }, 'structure_custom_template');
      custom_template_textarea.startup();
      
      // ********************************************************************
      // FILENAME TEMPLATE
      var filename_template_multi_select = new MultiSelect({
        name: 'filename_templates',
        required: false
      }, 'structure_filename_template');
      filename_template_multi_select.startup();
      
      // ADD FILENAME TEMPLATE BUTTON
      var add_filename_template_button = create_add_data_button(
              dijit.byId('add_structure_form').getParent(),
              'Add',
              'add_filename_template_dialog',
              create_add_filename_template_dialog,
              'structure_add_filename_template_button'
      );
      
{#        var add_filename_template_button = new Button({#}
{#          label: 'check',#}
{#          onClick: function(){#}
{#            alert(filename_template_multi_select.getValue());#}
{#          }#}
{#        }, 'structure_add_filename_template_button');#}
{#        add_filename_template_button.startup();#}
      
      // EDIT FILENAME TEMPLATE BUTTON
{#        var edit_filename_template_button = create_edit_data_button(#}
{#                dijit.byId('add_structure_form').getParent(),#}
{#                'Edit',#}
{#                'edit_filename_template_dialog',#}
{#                create_edit_filename_template_dialog,#}
{#                'structure_edit_filename_template_button',#}
{#                function(){#}
{#                  return filename_template_multi_select.get('value');#}
{#                }#}
{#        );#}
{#        edit_filename_template_button.startup();#}
      
      // ********************************************************************
      // ADD BUTTON
      var add_button = new Button({
        label: 'Add',
        type: 'button',
        onClick: function(){
          return add_structure_form.submit();
        }
      }, 'structure_add_button');
      add_button.startup();
      
      // ********************************************************************
      // CANCEL BUTTON
      var cancel_button = new Button({
        label: 'Cancel',
        type: 'button',
        onClick: function(){
          var dialog = dijit.byId('add_structure_dialog');
          dialog.destroyRecursive();
        }
      }, 'structure_cancel_button');
      cancel_button.startup();
  });
</script>
{#{% endblock %}#}

