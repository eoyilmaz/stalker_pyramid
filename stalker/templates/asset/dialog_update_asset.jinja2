{# Stalker a Production Asset Management System
 Copyright (C) 2009-2013 Erkan Ozgur Yilmaz

 This file is part of Stalker.

 This library is free software; you can redistribute it and/or
 modify it under the terms of the GNU Lesser General Public
 License as published by the Free Software Foundation;
 version 2.1 of the License.

 This library is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 Lesser General Public License for more details.

 You should have received a copy of the GNU Lesser General Public
 License along with this library; if not, write to the Free Software
 Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA
#}
<div class='dijitDialogPaneContentArea'>
  <form id='update_asset_form'>
    <table style='width: 100%;'>

        {# NAME #}
      <tr>
        <td class='label_column'>
          <label for='update_asset_name'>Name</label>
        </td>
        <td class='input_column'>
          <input id='update_asset_name'>
        </td>
      </tr>

        {# CODE #}
      <tr>
        <td class='label_column'>
          <label for='update_asset_code'>Code</label>
        </td>
        <td class='input_column'>
          <input id='update_asset_code'>
        </td>
      </tr>

        {# DESCRIPTION #}
      <tr>
        <td class='label_column'>
          <label for='update_asset_description'>Description</label>
        </td>
        <td class='input_column'>
          <input id='update_asset_description'>
        </td>
      </tr>

        {# TYPE #}
      <tr>
        <td class='label_column'>
          <label for='update_asset_type'>Type</label>
        </td>
        <td class='input_column'>
          <input id='update_asset_type'>
        </td>
      </tr>

        {# PROJECT #}
      <tr>
        <td class='label_column'>
          <label for='update_asset_project'>Project</label>
        </td>
        <td class='input_column'>
          <input id='update_asset_project'>
        </td>
      </tr>

      <tr>
        <td class='label_column'>
          <label for='update_asset_status'>Status</label>
        </td>
        <td class='input_column'>
          <input id='update_asset_status'>
        </td>
        <td class='button_column'>
          <button id='update_asset_add_status_button'>Add Status</button>
        </td>
      </tr>

    </table>
  </form>
</div>

<div class='dijitDialogPaneActionBar'>
  <button id='update_asset_submit_button'>OK</button>
  <button id='update_asset_cancel_button'>Cancel</button>
</div>

<script type='text/javascript'>
require(['dijit/registry', 'dojo/store/Memory', 'dijit/form/Form',
  'dijit/form/ValidationTextBox', 'dijit/form/TextBox',
  'dijit/form/FilteringSelect', 'dijit/form/ComboBox', 'dijit/form/Button',
  'dojo/store/JsonRest', 'stalker/submitForm', 'stalker/fieldUpdater',
  'stalker/dialogCaller', 'dojo/ready'],
        function(registry, Memory, Form, ValidationTextBox, TextBox,
                 FilteringSelect, ComboBox, Button, JsonRest, submitForm,
                 fieldUpdater, dialogCaller){

          // ************************************************************************
          // Form
          var update_asset_form = new Form({
            id: 'update_asset_form'
          }, 'update_asset_form');




          // ************************************************************************
          // Name
          var name_textBox = new ValidationTextBox({
            name: 'name',
            label: 'Name',
            placeHolder: 'Enter a name',
            value: '{{ asset.name }}',
            required: true
          }, 'update_asset_name');
          name_textBox.startup();




          // ************************************************************************
          // Code
          var code_textBox = new TextBox({
            name: 'code',
            label: 'Code',
            value: '{{ asset.code }}',
            placeHolder: 'Enter a code'
          }, 'update_asset_code');
          name_textBox.startup();




          // ************************************************************************
          // Description
          var description_textBox = new TextBox({
            name: 'description',
            label: 'Description',
            value: '{{ asset.description }}',
            placeHolder: 'Enter description'
          }, 'update_asset_description');
          description_textBox.startup();




          // ************************************************************************
          // Type
          var type_memory = new Memory({
            data: [
              {% for type_ in types %}
                {
                  id: '{{ type_.id }}',
                  name: '{{type_.name}}'
                },
              {% endfor %}
            ]
          });

          var type_comboBox = new ComboBox({
            name: 'type_name',
            required: true,
            store: type_memory,
            placeHolder: 'Enter A New Type or Select A Type'
          }, 'update_asset_type');

          // set value of Type

          if (type_memory.data[0] != undefined ){
            try {
              type_comboBox.attr('value', type_memory.data[0].name);
            } catch(e) {
              // don't do anything
            }
          }
          type_comboBox.attr('value','{{ asset.type.name }}');

          type_comboBox.startup();




          // ************************************************************************
          // Project
          var project_memory = new Memory({
            data: [
              {% for project in projects %}
                {
                  name: '{{ project.name }}',
                  id: '{{ project.id }}'
                },
              {% endfor %}
            ]
          });

          var project_select = new FilteringSelect({
            name: 'project_id',
            required: true,
            store: project_memory,
            placeHolder: 'Select A Project'
          }, 'update_asset_project');
          project_select.startup();

          project_select.set('value','{{ asset.project.id }}');
          project_select.set('disabled',true);

          // ************************************************************************
          // Status
          //
          // The Memory
          var status_memory = new JsonRest({
            target: 'get/statuses_for/Asset'
          });

          // The Field
          var status_filtering_select = new FilteringSelect({
            name: 'status_id',
            label: 'Status',
            required: true
          }, 'update_asset_status');
          status_filtering_select.startup();

          var status_filtering_select_selected_value = '{{ asset.status.id }}';

          var update_button_function = function(data){

            status_filtering_select.set('value',status_filtering_select_selected_value);

            if(data.length>0){

              asset_add_status_button.set('onClick', function(){

                status_filtering_select_selected_value = '';

                var dialog = dijit.byId('update_status_list_dialog');

                if (dialog != null){
                  dialog.destroyRecursive();
                }
                dialog = update_status_list_dialog_creator('Asset');
                // set the field updater
                dialog.set( 'related_field_updater', status_field_updater );
                // show the dialog
                dialog.show();
              });

              status_field_updater.set('callBack', function(){});

            }
          };

          // The Updater
          var status_field_updater = fieldUpdater({
            'memory': status_memory,
            'widget': status_filtering_select,
            'callBack': update_button_function
          });


          var asset_add_status_button = dialogCaller({
            label: 'Add Status',
            dialog_id: 'create_status_list_dialog',
            content_creator: create_status_list_dialog_creator,
            attach_to: 'update_asset_add_status_button',
            related_field_updater: status_field_updater,
            data_id: 'Asset'
          });

          asset_add_status_button.startup();
          status_field_updater({animate: true});





          // ************************************************************************
          // Submit Button
          var submit_button = new Button({
            label: 'OK',
            type: 'button',
            onClick: function(){
              submitForm({
                dialog: registry.byId('update_asset_dialog'),
                form: update_asset_form,
                additional_data: {
                  submitted: 'update',
                  type_name: type_comboBox.get('value')
                },
                url: 'update/asset/' + '{{asset.id}}',
                method: 'POST'
              });
            }
          }, 'update_asset_submit_button');
          submit_button.startup();


          // ************************************************************************
          // Cancel Button
          var cancel_button = new Button({
            label: 'Cancel',
            type: 'button',
            onClick: function(){
              registry.byId('update_asset_dialog').destroyRecursive();
            }
          }, 'update_asset_cancel_button');
          cancel_button.startup();

          update_asset_form.startup();

        });
</script>

