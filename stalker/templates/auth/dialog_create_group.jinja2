{# Stalker a Production Asset Management System
 Copyright (C) 2009-2013 Erkan Ozgur Yilmaz
 
 This file is part of Stalker.
 
 This library is free software; you can redistribute it and/or
 modify it under the terms of the GNU Lesser General Public
 License as published by the Free Software Foundation;
 version 2.1 of the License.

 This library is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 Lesser General Public License for more details.

 You should have received a copy of the GNU Lesser General Public
 License along with this library; if not, write to the Free Software
 Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA
#}
<div class='dijitDialogPaneContentArea'>
    <form id='group_form'>
        <table style='width: 100%'>

            {# NAME #}
            <tr>
                <td class='label_column'>
                    <label for='group_name'>Name</label>
                </td>
                <td class='input_column'>
                    <input id='group_name'>
                </td>
            </tr>


            <tr>
                <td class='label_column'>
                    <span>Permissions</span>
                </td>
                <td class='input_column'>
                    <div id='permission_checkboxes'>
                        <table>
                            <thead>
                                <tr style='font-weight: bold'>
                                    <th style='text-align: right'>Class Name</th>
                                    {% for action in actions %}
                                        <th style="width: 55px;">{{ action }}</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for entity in entity_types %}
                                    <tr>
                                        <td style='text-align: right'>{{ entity.name }}</td>
                                        {% for action in actions %}
                                            <td style='text-align: center'>
                                                <input id='{{ action }}_{{ entity.name }}' name='{{ action }}_{{ entity.name }}' type='checkbox' data-dojo-type='dijit/form/CheckBox' value='Allow'>
                                            </td>
                                        {% endfor %}
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </td>
            </tr>

        </table>
    </form>
</div>

<div class='dijitDialogPaneActionBar'>
    <button id='group_ok_button'>Ok</button>
    <button id='group_cancel_button'>Cancel</button>
</div>


<script type='text/javascript'>
    require([
        'dijit/registry',
        'dijit/form/Form',
        'dijit/form/Button',
        'dijit/form/CheckBox',
        'dijit/form/ValidationTextBox',
        'dojo/ready',
        'stalker/submitForm'
    ], function (registry, Form, Button, CheckBox, ValidationTextBox, ready,
                 submitForm) {

        ready(function(){
            // ********************************************************************
            // Form
            var group_form = new Form({
                id: 'group_form'
            }, 'group_form');
            group_form.startup();
            
            var dialog = group_form.getParent();
            
            // ********************************************************************
            // Name
            var name_validationTextBox = new ValidationTextBox({
                name: 'name',
                required: true,
                {% if mode=='UPDATE' %}
                    value: '{{ group.name }}'
                {% endif %}
            }, 'group_name');
            name_validationTextBox.startup();
            
            {% if mode=='UPDATE' %}
                // update checkboxes
                var access;
                var action;
                var class_name;
                var checkBox_id;
                var checkBox;
                {% for permission in group.permissions %}
                    {% if  permission.access == 'Allow' %}
                        access = '{{ permission.access }}';
                        action = '{{ permission.action }}';
                        class_name = '{{ permission.class_name }}';
                        
                        checkBox_id = action + '_' + class_name;
                        checkBox = registry.byId(checkBox_id);
                        checkBox.set('value', 'checked');
                    {% endif %}
                {% endfor %}
            {% endif %}
            
            
            // ********************************************************************
            // OK Button
            var ok_button = new Button({
                label: 'OK',
                type: 'button',
                onClick: function () {
                    var url;
                    
                    {% if mode=='CREATE' %}
                        url = 'create/group';
                    {% elif mode=='UPDATE' %}
                        url = 'update/group';
                    {% endif %}
                    submitForm({
                        dialog: dialog,
                        form: group_form,
                        additional_data: {
                            {% if mode=='UPDATE' %}
                                group_id: {{ group.id }}
                            {% endif %}
                        },
                        url: url,
                        method: 'POST'
                    });
                }
            }, 'group_ok_button');
            ok_button.startup();
    
            // ********************************************************************
            // Cancel Button
            var cancel_button = new Button({
                label: 'Cancel',
                type: 'button',
                onClick: function () {
                    dialog.destroyRecursive();
                }
            }, 'group_cancel_button');
            cancel_button.startup();
        });
    });
</script>
