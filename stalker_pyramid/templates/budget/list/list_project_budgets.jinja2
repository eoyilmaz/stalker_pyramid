{# Stalker Pyramid a Web Base Production Asset Management System
 Copyright (C) 2009-2014 Erkan Ozgur Yilmaz

 This file is part of Stalker Pyramid.

 This library is free software; you can redistribute it and/or
 modify it under the terms of the GNU Lesser General Public
 License as published by the Free Software Foundation;
 version 2.1 of the License.

 This library is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 Lesser General Public License for more details.

 You should have received a copy of the GNU Lesser General Public
 License along with this library; if not, write to the Free Software
 Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA
#}
{% extends "base.jinja2" %}

{# SIDEBAR #}
{% block sidebar %}

    {% include 'sidebar.jinja2' %}

{% endblock sidebar %}

{# BREADCRUMBS #}
{% block breadcrumbs %}

    {% set page_title='Budgets' %}
    {% include 'breadcrumb/breadcrumbs.jinja2' %}

{% endblock breadcrumbs %}


{# PAGE-CONTENT #}
{% block page_content %}

{#    <div class="row-fluid">#}
{#        <div id="gantt_here" style='width:100%;height:300px;'></div>#}
{#    </div>#}
{#    <div class="space-6"></div>#}
    <div class="row-fluid">
        {% set add_button_address=request.route_path('create_budget_dialog', _query={'project_id':entity.id, 'came_from':request.current_route_path()}) %}
        {% set address=request.route_path('get_project_budgets', id=entity.id) %}
        {% set list_item_type='Budget' %}
        {% include 'components/data_table.jinja2' %}
    </div>


{% endblock page_content %}

{# EXTRA-SCRIPTS #}
{% block extrascripts %}

    {% raw %}
        <script id="tmpl_itemThead" type="text/x-dot-template">
            <tr>
                <th>Created Date</th>
                <th>Budget</th>
                <th>Created By</th>
                <th>Type</th>
                <th>Status</th>
                <th>Date</th>
                <th>Description</th>
                <th></th>
            </tr>
        </script>
    {% endraw %}

    {% raw %}
        <script id="tmpl_itemRow" type="text/x-dot-template">
            <tr>
                <td style="width:100px;">{{=it.date_created}}
                </td>
                <td><a href='{{=it.item_view_link}}'>{{=it.name}} </a>
                </td>
                <td><a href='/users/{{=it.created_by_id}}/view'>{{=it.created_by_name}}</a>
                </td>
                <td>
                    <span> {{=it.type_name}}</span>
                </td>
                <td>
                    <span class="label label-large label-status_{{=it.status_code }}"> {{=it.status_name }}</span>
                </td>
                <td>
                    {{=it.start_date}} - {{=it.end_date}}
                </td>
                <td>
                    <span> {{=it.description }}</span>
                </td>
                <td>
                    {{ if (it.item_update_link) { }}
                    <a  class="blue"
                        data-target="#dialog_template"
                        data-toggle="modal"
                        data-keyboard=false
                        href="{{=it.item_update_link}}">
                        <i class="icon-edit bigger-130"></i>
                    </a>{{ } }}

                    {{ if (it.item_duplicate_link) { }}
                    <a  class="purple"
                        data-target="#dialog_template"
                        data-toggle="modal"
                        data-keyboard=false
                        href="{{=it.item_duplicate_link}}">
                        <i class="icon-copy bigger-130"></i>
                    </a>{{ } }}

                    {{ if (it.item_remove_link) { }}
                    <a  class="red"
                        data-target="#dialog_template"
                        data-toggle="modal"
                        data-keyboard=false
                        href="{{=it.item_remove_link}}">
                        <i class="icon-trash bigger-130"></i>
                    </a>{{ } }}
                </td>
            </tr>
        </script>
    {% endraw %}

    <script src='{{ request.static_url("stalker_pyramid:static/dhtmlx/dhtmlxSuite/dhtmlx.js") }}'></script>
    <script src='{{ request.static_url("stalker_pyramid:static/dhtmlx/dhtmlxgantt.js") }}'></script>
    <script src='{{ request.static_url("stalker_pyramid:static/dhtmlx/api.js") }}'></script>
    <script src='{{ request.static_url("stalker_pyramid:static/moment/moment.min.js") }}'></script>
    <script src='{{ request.static_url("stalker_pyramid:static/dhtmlx/ext/dhtmlxgantt_multiselect.js") }}' type='text/javascript' charset='utf-8'></script>

    <script type="text/javascript">

        var tableParameters = {};
        var sortingParameters = [[0, 'desc'], [1, 'desc']];
        var tableDataAddress = '{{ request.route_path('get_project_budgets', id=entity.id) }}';

{#        function callBackFunction(data){#}
{##}
{#            gantt.init("gantt_here");#}
{##}
{#            gantt.config.scale_unit = "year";#}
{#            gantt.config.step = 1;#}
{#            gantt.config.date_scale = "%Y";#}
{#            gantt.config.min_column_width = 50;#}
{##}
{#            gantt.config.scale_height = 90;#}
{##}
{#            var monthScaleTemplate = function(date){#}
{#            var dateToStr = gantt.date.date_to_str("%M");#}
{#            var endDate = gantt.date.add(date, 2, "month");#}
{#            return dateToStr(date) + " - " + dateToStr(endDate);#}
{#            };#}
{##}
{#            gantt.config.subscales = [#}
{#            {unit:"month", step:3, template:monthScaleTemplate},#}
{#            {unit:"month", step:1, date:"%M" }#}
{#            ];#}
{##}
{#           #}
{##}
{#            gantt.templates.task_cell_class = function(task, date){#}
{#                    if(!gantt.isWorkTime(date))#}
{#                        return "week_end";#}
{#                    return "";#}
{#                };#}
{#            gantt.config.columns = [#}
{#                    {name:"text", label:"Budget Name", width:150, tree:true }#}
{#                ];#}
{##}
{#            var budgets = {data:[]};#}
{#            budgets.data.push({#}
{#                                id:'{{ entity.id }}',#}
{#                                text:'{{ entity.name }}',#}
{#                                open:true#}
{#                            });#}
{##}
{#            for(var k=0; k<data.length;k++){#}
{#                var budget = {#}
{#                                id:data[k].id,#}
{#                                text:data[k].name,#}
{#                                start_date:(moment(parseInt(data[k].generic_data.start_date))).format('DD MM YYYY'),#}
{#                                end_date:(moment(parseInt(data[k].generic_data.end_date))).format('DD MM YYYY'),#}
{#                                parent: '{{ entity.id }}',#}
{#                                open:false#}
{#                            }#}
{#                budgets.data.push(budget);#}
{#            }#}
{#            gantt.parse(budgets);#}
{##}
{#        }#}


    </script>

{% endblock extrascripts %}
