{# Stalker Pyramid a Web Base Production Asset Management System
 Copyright (C) 2009-2013 Erkan Ozgur Yilmaz
 
 This file is part of Stalker Pyramid.
 
 This library is free software; you can redistribute it and/or
 modify it under the terms of the GNU Lesser General Public
 License as published by the Free Software Foundation;
 version 2.1 of the License.

 This library is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 Lesser General Public License for more details.

 You should have received a copy of the GNU Lesser General Public
 License along with this library; if not, write to the Free Software
 Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA
#}
{% extends "base.jinja2" %}
{% block main_view %}

{% set user=entity %}
<div style="background-color: #45b8cc;" class="page_title"></div>

{# Avatar #}
<div id='user_avatar'
     class='thumbnail'>
    {% if not user.thumbnail %}
        <img src='{{ request.static_url("stalker_pyramid:static/stalker/images/Placeholder_0.png") }}'
             alt=''
             style='width:auto; height:150px;'>
    {% else %}
        <img src='{{ user.thumbnail.full_path }}'
             alt=''
             style='width:auto; height:150px;'>
    {% endif %}
    <div class='thumbnail_menu'>&nbsp</div>
</div>

{# Basic Info #}
<div id='user_info' class='summary_info'>
    <h4 style='margin: 0; text-align: left;'>{{ user.name }}</h4>
    <h5 style='margin: 0; text-align: left;'>({{ user.login }})</h5>
    <table>
        <tr>
            <td style='text-align: right'><b>Messages</b></td>
            <td>&nbsp;</td>
            <td>({{ user.messages|count }})</td>
        </tr>
        <tr>
            <td style='text-align: right'><b>Tasks</b></td>
            <td>&nbsp;</td>
            <td>({{ user.tasks|count }})</td>
        </tr>
        <tr>
            <td style='text-align: right'><b>Open Tickets</b></td>
            <td>&nbsp;</td>
            <td>({{ user.open_tickets|count }})</td>
        </tr>
        <tr>
            <td>
                {% if has_permission('Update_User') or user==logged_in_user %}
                    <button id='update_user_button'>Update</button>
                {% endif %}
            </td>
        </tr>
    </table>
</div>
<script type="text/javascript">
    require([
        'dijit/form/Button',

        'stalker/js/dialogs',
        'stalker/js/dialogCaller',
        'stalker/js/thumbnailMenu',

        'dojo/domReady!'
    ], function (Button, dialogs, dialogCaller, thumbnailMenu) {
        {% if has_permission('Update_User') or user==logged_in_user %}
            // UPDATE USER BUTTON
            var update_user_button = dialogCaller({
                label: 'Update',
                dialog_id: 'update_user_dialog',
                content_creator: dialogs.update_user_dialog,
                attach_to: 'update_user_button',
                data_id: {{ user.id }}
            });
            update_user_button.startup();

            thumbnailMenu({
                targetNodeIds: ['user_avatar'],
                selector: '.thumbnail_menu',
                entity_id: {{ user.id }},
                related_field_updater: function(){
                    var content_pane = update_user_button.getParent();
                    if (content_pane != null){
                        content_pane.refresh();
                    }
                }
            });
        {% endif %}
    });
</script>
{% endblock %}
