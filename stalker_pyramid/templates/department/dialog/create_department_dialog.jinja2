{% set department=entity %}
<div class="row-fluid">
    <form id='department_form'
          class='form-horizontal'
          role='form'
          method="post"
            >

        <div class="row-fluid">
            {# Name #}
            <div class="control-group">
                <label class="span2 control-label"
                       for="department_name">Name</label>

                <div class="span6">
                    <input id="department_name"
                           name='name'
                           type="text"
                           class="form-control"
                           placeholder="Name"
                           required>
                </div>
            </div>

            {# Lead #}
            <div class="control-group">
                <label for="department_lead"
                       class="span2 control-label">Lead</label>

                <div class="span6">
                    <select id="department_lead"
                            name='lead'
                            type="lead"
                            class="form-control"
                            placeholder="Lead"
                            >
                    </select>

                </div>
            </div>
        </div>


        {# TAGS #}
        <div class="control-group">
            <label class="span2 control-label" for="form-field-tags">Tag
                input</label>

            <div class="span6">
                <input id="department_tags"
                       type="text"
                       name="tags"
                       id="form-field-tags"
                       placeholder="Enter tags ..."/>
            </div>
        </div>

        {#Description #}
        <div class='control-group'>
            <label class='span2 control-label'
                   for='department_description'>Description</label>

            <div class='span6'>
                <textarea id="department_description"
                          name='description'
                          class="autosize-transition span12"
                          style="overflow: hidden;
                                 word-wrap: break-word;
                                 resize: horizontal;
                                 height: 50px;"
                        ></textarea>
            </div>
        </div>


    </form>


</div>


<script src='{{ request.static_url("stalker_pyramid:static/ace/js/bootstrap-tag.min.js") }}'></script>



<script type="text/javascript">

    function init_dialog() {

        console.debug('starting to initialize department dialog!!!');

        $('#dialog_template_label').find('span').remove();
        $('#dialog_template_label').append('<span>New Department</span>')

        $('#dialog_template_body').attr('style', "height: 350px");


        {# Chosen Field Updater #}
        var chosen_field_creator = function (field, url, data_template) {
            // fill image format with new json data
            return $.getJSON(url).then(function (data) {
                // remove current data
                field.empty();

                // append new options to the select
                for (var i = 0; i < data.length; i++) {
                    field.append(data_template(data[i]));
                }

                // convert it to chosen
                field.chosen();
            });
        };


        {# ***************************************************************** #}
        {# User #}
        $(document).ready(function () {
            {% raw %}
            var user_option_template = doT.template(
                    '<option value={{=it.id}}>{{=it.name}}</option>'
            );
            {% endraw %}

            var user = $('#department_lead');
            var deferred = chosen_field_creator(user, '/users/', user_option_template);

        });

        {# ***************************************************************** #}
        {# Submit Button #}

        var submit_button = $('#dialog_template_submit_button');
        submit_button.on('click', function (e) {
            e.stopPropagation();
            e.preventDefault();

            submit_button.button('loading');
            var department_form = $('#department_form');

            if (department_form.validate()) {
                $.post(
                                "{{ request.route_url('create_department') }}",
                                department_form.serialize()
                        ).done(function () {
                            window.location.assign('{{ came_from }}');
                        }).fail(function () {
                            bootbox.alert(jqXHR.responseText);
                            submit_button.button('reset');
                        });
            }
        });


        console.debug('finished initializing the department dialog!')
    }
</script>

<script type="text/javascript">

    function destruct_dialog() {

        $('#department_name').unbind();
        $('#department_lead').unbind();
        $('#form-field-tags').unbind();
        $('#department_description').unbind();
        $('#dialog_template_submit_button').unbind();

        $('#dialog_template').data('modal', null);

    }
</script>



