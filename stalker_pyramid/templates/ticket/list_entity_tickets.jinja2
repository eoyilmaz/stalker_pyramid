{% extends "base.jinja2" %}

{% block sidebar %}
    {% include 'sidebar.jinja2' %}

{% endblock sidebar %}

{% block breadcrumbs %}
    {% set page_title='Tickets' %}
    {% include 'breadcrumbs.jinja2' %}
{% endblock breadcrumbs %}

{% block page_content %}
    {% set page_title='Tickets' %}
    {% include 'page_header.jinja2' %}

    {% set tickets=entity.tickets %}

    <div class="table-header">
        Tickets
    </div>
    <table id="tickets_table"
           class="table table-striped table-bordered table-hover">
        <thead>
        <tr>
            <th>Ticket</th>
            <th class="hidden-480">Summary</th>
            <th>Type</th>
            <th>Severity</th>
            <th>Status</th>
            <th>Owner</th>
            <th>Created By</th>
            <th class="hidden-phone">Created At</th>
        </tr>
        </thead>
        <tbody>
        
        </tbody>
    </table>

{% endblock page_content %}




{% block extrascripts %}
<script src='{{ request.static_url("stalker_pyramid:static/ace/js/jquery.dataTables.min.js") }}'></script>
<script src='{{ request.static_url("stalker_pyramid:static/ace/js/jquery.dataTables.bootstrap.js") }}'></script>


{% raw %}
<script id="tmpl_ticketRow" type="text/x-dot-template">
    <tr>
        <td><a href='#'>#{{=it.number}}</a></td>
        <td class="hidden-480"><a href='#'>{{=it.summary}}</a></td>
        <td>{{=it.type}}</td>
        <td>{{=it.priority}}</td>
        <td>{{=it.status}}</td>
        <td><a href='/users/{{=it.owner_id}}/view'>{{=it.owner_name}}</a></td>
        <td><a href='/users/{{=it.created_by_id}}/view'>{{=it.created_by_name}}</a></td>
        <td class="hidden-phone">{{=it.date_created}}</td>
    </tr>
</script>
{% endraw %}



<script>
    // fill tickets table with dynamic data
    $.getJSON('/entities/{{ entity.id }}/tickets/').then(function(data){

        var tickets = data;
        var ticket_template = doT.template($('#tmpl_ticketRow').html());

        // wait until document is ready
        $(function(){
            var i;
            var table_body = $('#tickets_table>tbody');
            for (i=0; i<data.length; i++) {
                // fix dates
                data[i].date_created = new Date(data[i].date_created).format('yyyy-mm-dd HH:MM');
                // append it to the table
                table_body.append(ticket_template(data[i]));
            }

            var oTable1 = $('#tickets_table').dataTable();

        });
    });
    
</script>
    
    
{% endblock extrascripts %}
