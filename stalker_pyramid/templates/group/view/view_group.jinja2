{% extends "base.jinja2" %}

{# BREADCRUMBS #}
{% block breadcrumbs %}
    {% set page_title='Permissions' %}
    {% include 'breadcrumb/breadcrumbs.jinja2' %}
{% endblock breadcrumbs %}

{# SIDEBAR #}
{% block sidebar %}
    {% include 'sidebar.jinja2' %}
{% endblock sidebar %}

{# PAGE-CONTENT #}
{% block page_content %}

    {% set page_title='Summary' %}
    {% set page_desc=entity.description %}
    {% include 'page_header.jinja2' %}


    <div class="row-fluid">
        <div class="widget-box span6">
            <div class="widget-header widget-header-blue widget-header-flat">
                <h4>Permissions</h4>
                {% if has_permission('Update_Group') %}
                    <div class="widget-toolbar">
                        <label>
                            <input id="skip-validation" type="checkbox"
                                   class="ace ace-switch ace-switch-4"/>
                            <span class="lbl"></span>
                        </label>
                    </div>
                {% endif %}
            </div>

            <div class="widget-body">
                <div class="widget-main">
                    <div class="row-fluid">

                        <form id='group_permission_form'
                              class='form-horizontal'
                              role='form'
                              method='post'>
                            {% set mode='Update' %}
                            {% set address=request.route_url('get_group_permissions', id=entity.id) %}
                            {% include 'group/list/list_group_permissions.jinja2' %}
                        </form>

                    </div>
                    <div class="space-10"></div>
                    <div class="row-fluid">
                        <button id='permissions_submit_button'
                                class='btn btn-success pull-right' disabled>
                            <i class="icon-edit"></i> Update
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>




{% endblock page_content %}

{% block extrascripts %}

    <script type="text/javascript">


        var permissions_loaded = function(){

            $('.ace-checkbox-2').attr('disabled', true);

        }

        {% if has_permission('Update_Group') %}

            $('#skip-validation').removeAttr('checked').on('click', function () {
                if (this.checked) {

                    $('.ace-checkbox-2').attr('disabled', false);

                    $('#permissions_submit_button').attr('disabled', false);

                    $('.ace-checkbox-2').on('click', function () {

                        console.log(this.id + ' ' + this.checked)
                        if (!this.checked) {
                            this.value = '';
                            return;
                        }
                        this.value = 'Allow';
                    });

                } else {

                    $('.ace-checkbox-2').attr('disabled', true);
                    $('#permissions_submit_button').attr('disabled', true);

                }
            });

        {% endif %}

        $(document).ready(function () {


            var submit_button = $('#permissions_submit_button');
            submit_button.on('click', function (e) {

                e.stopPropagation();
                e.preventDefault();
                submit_button.button('loading');

                var group_permission_form = $("#group_permission_form");

                bootbox.confirm(
                        '<div class="alert alert-info bigger-110">This will update the permission settings of {{ entity.name }}' +
                                '<br><br><strong>Are you sure?</strong></div>',
                        function (result) {
                            if (result) {
                                // get the ids and send it to the server

                                $.post('/groups/{{ entity.id}}/update', group_permission_form.serialize() + '&' +
                                                $.param({ 'group_id': '{{ entity.id }}', 'name': '{{ entity.name }}', 'description': '{{ entity.description }}'})
                                        ).done(function (response_text) {
                                            bootbox.alert(response_text);
                                            window.location.assign('{{ came_from }}');
                                            submit_button.button('reset');
                                        }).fail(function (jqXHR) {
                                            bootbox.alert(jqXHR.responseText);
                                            submit_button.button('reset');
                                        });
                            }
                        }
                )
            });
        });

    </script>
{% endblock extrascripts %}