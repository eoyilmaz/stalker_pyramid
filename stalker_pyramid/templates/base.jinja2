{# Stalker Pyramid a Web Base Production Asset Management System
 Copyright (C) 2009-2013 Erkan Ozgur Yilmaz
 
 This file is part of Stalker Pyramid.
 
 This library is free software; you can redistribute it and/or
 modify it under the terms of the GNU Lesser General Public
 License as published by the Free Software Foundation;
 version 2.1 of the License.

 This library is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 Lesser General Public License for more details.

 You should have received a copy of the GNU Lesser General Public
 License along with this library; if not, write to the Free Software
 Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA
#}
<!DOCTYPE html>
<html>
<head>
    <title>Stalker Pyramid v{{ stalker_pyramid.__version__ }}</title>
    <meta charset='utf-8'>
    <meta http-equiv='Content-Type' content='text/html;charset=UTF-8'/>
    <meta name='keywords' content='python web application'/>
    <meta name='description' content='pyramid web application'/>
    <link rel='shortcut icon'
          href='{{ request.static_url("stalker_pyramid:static/stalker/images/favicon.ico") }}'/>
    <link rel='stylesheet' type='text/css' media='all' charset='utf-8'
          href='{{ request.static_url("stalker_pyramid:static/stalker/css/stalker.css") }}'/>
    
    {# load jQuery and jQuery Gantt first#}
    {#    <link rel=stylesheet media='all'#}
    {#          href='{{ request.static_url("stalker_pyramid:static/jQueryGantt/libs/dateField/jquery.dateField.css") }}'#}
    {#          type="text/css">#}
{#    <link rel=stylesheet media='all'#}
{#          href='{{ request.static_url("stalker_pyramid:static/jQueryGantt/css/gantt.css") }}'#}
{#          type="text/css">#}

    {# load date.format #}
    <script src='{{ request.static_url("stalker_pyramid:static/stalker/date.format.js") }}'></script>


    <script src='{{ request.static_url("stalker_pyramid:static/jquery/1.7/jquery.min.js") }}'></script>
{#    <script src='{{ request.static_url("stalker_pyramid:static/jqueryui/1.8/jquery-ui.min.js") }}'></script>#}

{#    <script src='{{ request.static_url("stalker_pyramid:static/jQueryGantt/libs/jquery.livequery.min.js") }}'></script>#}
{#    <script src='{{ request.static_url("stalker_pyramid:static/jQueryGantt/libs/jquery.timers.js") }}'></script>#}
{#    <script src='{{ request.static_url("stalker_pyramid:static/jQueryGantt/libs/platform.js") }}'></script>#}
{#    <script src='{{ request.static_url("stalker_pyramid:static/jQueryGantt/libs/date.js") }}'></script>#}
{#    <script src='{{ request.static_url("stalker_pyramid:static/jQueryGantt/libs/i18nJs.js") }}'></script>#}
    {#    <script src='{{ request.static_url("stalker_pyramid:static/jQueryGantt/libs/dateField/jquery.dateField.js") }}'></script>#}
{#    <script src='{{ request.static_url("stalker_pyramid:static/jQueryGantt/libs/JST/jquery.JST.js") }}'></script>#}

{#    <script src='{{ request.static_url("stalker_pyramid:static/jQueryGantt/ganttUtilities.js") }}'></script>#}
{#    <script src='{{ request.static_url("stalker_pyramid:static/jQueryGantt/ganttProject.js") }}'></script>#}
{#    <script src='{{ request.static_url("stalker_pyramid:static/jQueryGantt/ganttResource.js") }}'></script>#}
{#    <script src='{{ request.static_url("stalker_pyramid:static/jQueryGantt/ganttLink.js") }}'></script>#}
{#    <script src='{{ request.static_url("stalker_pyramid:static/jQueryGantt/ganttTask.js") }}'></script>#}
{#    <script src='{{ request.static_url("stalker_pyramid:static/jQueryGantt/ganttTimeLog.js") }}'></script>#}
{#    <script src='{{ request.static_url("stalker_pyramid:static/jQueryGantt/ganttDrawer.js") }}'></script>#}
{#    <script src='{{ request.static_url("stalker_pyramid:static/jQueryGantt/ganttGridEditor.js") }}'></script>#}
{#    <script src='{{ request.static_url("stalker_pyramid:static/jQueryGantt/ganttMaster.js") }}'></script>#}

    {# DOJO COMPRESSED #}
    <link rel='stylesheet' type='text/css' media='all' charset='utf-8'
          href='{{ request.static_url("stalker_pyramid:static/dojo/resources/dojo.css") }}'/>
    <link rel='stylesheet' type='text/css' media='all' charset='utf-8'
          href='{{ request.static_url("stalker_pyramid:static/dijit/themes/claro/claro.css") }}'/>
{#    <link rel='stylesheet' type='text/css' media='all' charset='utf-8'#}
{#          href='{{ request.static_url("stalker_pyramid:static/dojox/grid/resources/claroGrid.css") }}'/>#}
    <link rel='stylesheet' type='text/css' media='all' charset='utf-8'
          href='{{ request.static_url("stalker_pyramid:static/dojox/form/resources/UploaderFileList.css") }}'/>
    <link rel='stylesheet'
          href='{{ request.static_url("stalker_pyramid:static/dojox/form/resources/FileInput.css") }}'/>

    {# DGRID GANTT #}
    <link rel='stylesheet' type='text/css' media='all' charset='utf-8'
          href='{{ request.static_url("stalker_pyramid:static/stalker/css/GanttColumn.css") }}'/>

    {# DGRID #}
    <link rel='stylesheet' type='text/css' media='all' charset='utf-8'
      href='{{ request.static_url("stalker_pyramid:static/dgrid/css/skins/claro.css") }}'/>
    <link rel='stylesheet' type='text/css' media='all' charset='utf-8'
      href='{{ request.static_url("stalker_pyramid:static/dgrid/css/columnset.css") }}'/>
    <link rel='stylesheet' type='text/css' media='all' charset='utf-8'
      href='{{ request.static_url("stalker_pyramid:static/dgrid/css/dgrid.css") }}'/>
    <link rel='stylesheet' type='text/css' media='all' charset='utf-8'
      href='{{ request.static_url("stalker_pyramid:static/dgrid/css/has-transforms3d.css") }}'/>

    {# DOJO MODIFIED CSS #}
    <link rel='stylesheet' type='text/css' media='all' charset='utf-8'
          href='{{ request.static_url("stalker_pyramid:static/stalker/css/dojo_modified.css") }}'/>

    {# DOJO JAVA SCRIPTS #}
    <script type='text/javascript'
            data-dojo-config="async: true, parseOnLoad: true"
            src='{{ request.static_url("stalker_pyramid:static/dojo/dojo.js") }}'>
    </script>

</head>
<body class='claro'>

{# TODO: Support Multiple monitors by allowing the user to detach content panels #}

{# TEMPLATES #}
<div id="ganttEditorTemplates" style="display:none;">
    <div class="__template__" type="TASKSEDITHEAD"><!--
        <table class="gdfTable" cellspacing="0" cellpadding="0" style='width: 1000px'>
            <thead>
                <tr style="height:40px">
                    <th class="gdfColHeader gdfResizable" style="width:20px;">#</th>
                    <th class="gdfColHeader gdfResizable" style="width:35px;">id</th>
                    <th class="gdfColHeader gdfResizable" style="width:250px;">name</th>
                    <th class="gdfColHeader gdfResizable" style="width:105px;">start</th>
                    <th class="gdfColHeader gdfResizable" style="width:105px;">end</th>
                    <th class="gdfColHeader gdfResizable" style="width:35px;">timing</th>
                    <th class="gdfColHeader gdfResizable" style="width:100px;">depends</th>
                    <th class="gdfColHeader gdfResizable" style="width:400px; text-align: left;">resources</th>
                    <th class="gdfColHeader gdfResizable" style="width:670px;"></th>
                </tr>
            </thead>
        </table>
    --></div>

    <div class="__template__" type="RESOURCESEDITHEAD"><!--
        <table class="gdfTable" cellspacing="0" cellpadding="0" style='width: 1000px'>
            <thead>
                <tr style="height:40px">
                    <th class="gdfColHeader gdfResizable" style="width:20px;">#</th>
                    <th class="gdfColHeader gdfResizable" style="width:35px;">id</th>
                    <th class="gdfColHeader gdfResizable" style="width:250px;">name</th>
                    <th class="gdfColHeader gdfResizable" style="width:1415px;"></th>
                </tr>
            </thead>
        </table>
    --></div>


    <div class="__template__" type="PROJECTROW"><!--
        <tr dataId="(#=obj.id#)" class="projectEditRow (#=obj.type#)Row">
            <th class="gdfCell" align="right"><span class="taskRowIndex">(#=obj.getRow()+1#)</span></th>
            <td class="gdfCell" align="right"><span>(#=obj.id#)</span></td>
            <td class="gdfCell indentCell" style="font-weight: bold"><div class="(#=obj.collapsed ? 'folder collapsed': 'folder uncollapsed'#)"></div><div style='position:relative;left:15px;'>(#=obj.link()#)</div></td>
            <td class="gdfCell"><div class="date start"></div></td>
            <td class="gdfCell"><div class="date end"></div></td>
            <td class="gdfCell"></td>
            <td class="gdfCell"></td>
            <td class="gdfCell taskAssigs"></td>
        </tr>
    --></div>

    <div class="__template__" type="PARENTTASKROW"><!--
        <tr dataId="(#=obj.id#)" class="parentTaskEditRow (#=obj.type#)Row">
            <th class="gdfCell" align="right"><span class="taskRowIndex">(#=obj.getRow()+1#)</span></th>
            <td class="gdfCell" align="right" style="background-color: (#=obj.progress >= 100 ? 'rgb(153, 255, 51)' : 'red'#)"><span>(#=obj.id#)</span></td>
            <td class="gdfCell indentCell" style="padding-left:(#=obj.getParents().length*15#)px; (#=obj.getChildren().length>0?'font-weight: bold':''#)"><div class="(#=obj.collapsed ? 'folder collapsed': 'folder uncollapsed'#)"></div><div style='position:relative;left:15px;'>(#=obj.link()#)</div></td>
            <td class="gdfCell"><div class="date start"></div></td>
            <td class="gdfCell"><div class="date end"></div></td>
            <td class="gdfCell"><div class="timing">(#=obj.schedule_model.toUpperCase()[0]#): (#=obj.schedule_timing#)(#=obj.schedule_unit#)</div></td>
            <td class="gdfCell">(#=obj.getDependsLinks()#)</td>
            <td class="gdfCell">(#=obj.getResourcesLinks()#)</td>
        </tr>
    --></div>

    <div class="__template__" type="TASKROW"><!--
        <tr dataId="(#=obj.id#)" class="taskEditRow (#=obj.type#)Row">
            <td class="gdfCell" align="right"><span class="taskRowIndex">(#=obj.getRow()+1#)</span></td>
            <td class="gdfCell" align="right" style="background-color: (#=obj.progress >= 100 ? 'rgb(153, 255, 51)' : 'red'#)"><span>(#=obj.id#)</span></td>
            <td class="gdfCell indentCell" style="padding-left:(#=obj.getParents().length*15#)px; (#=obj.getChildren().length>0?'font-weight: bold':''#)"><div style='position:relative;left:15px;'>(#=obj.link()#)</div></td>
            <td class="gdfCell"><div class="date start"></div></td>
            <td class="gdfCell"><div class="date end"></div></td>
            <td class="gdfCell"><div name="timing">(#=obj.schedule_model.toUpperCase()[0]#): (#=obj.schedule_timing#)(#=obj.schedule_unit#)</div></td>
            <td class="gdfCell">(#=obj.getDependsLinks()#)</td>
            <td class="gdfCell">(#=obj.getResourcesLinks()#)</td>
            <td class="gdfCell"></td>
        </tr>
    --></div>


    <div class="__template__" type="RESOURCEROW"><!--
        <tr dataId="(#=obj.id#)" class="resourceEditRow">
            <td class="gdfCell" align="right"><span class="resourceRowIndex">(#=obj.getRow()+1#)</span></td>
            <td class="gdfCell" align="right"><span>(#=obj.id#)</span></td>
            <td class="gdfCell">(#=obj.link()#)</td>
            <td class="gdfCell"></td>
        </tr>
    --></div>

    <div class="__template__" type="TASKEMPTYROW"><!--
        <tr class="taskEditRow emptyRow" >
            <th class="gdfCell" align="right"></th>
            <td class="gdfCell"></td>
            <td class="gdfCell"></td>
            <td class="gdfCell"></td>
            <td class="gdfCell"></td>
            <td class="gdfCell"></td>
            <td class="gdfCell"></td>
            <td class="gdfCell" align="left"></td>
            <td class="gdfCell"></td>
        </tr>
    --></div>

    <div class="__template__" type="RESOURCEEMPTYROW"><!--
        <tr class="resourceEditRow emptyRow" >
            <th class="gdfCell" align="right"></th>
            <td class="gdfCell"></td>
            <td class="gdfCell" align="left"></td>
            <td class="gdfCell"></td>
        </tr>
    --></div>

    <div class="__template__" type="PROJECTBAR"><!--
        <tr class="projectBox" projectId="(#=obj.id#)" >
            <td>
                <div class="layout">
                    <div class="projectLabel">(#=obj.link()#)</div>
                </div>
            </td>
        </tr>
    --></div>

    <div class="__template__" type="TASKBAR"><!--
        <tr class="taskBox" dataId="(#=obj.id#)">
            <td>
                <div class="layout (#=obj.hasExternalDep?'extDep':''#)">
                    <div class="taskProgress" style="width:(#=obj.progress>100?100:obj.progress#)%;"></div>
                    <div class="taskExtraTiming" style="width:(#=(obj.schedule_timing - obj.bid_timing)/obj.schedule_timing*100#)%;;"></div>
                    <div class="taskScheduleModel"
                       style="position: absolute; text-align: center; width: 100%;">
                       (#=obj.schedule_model.toUpperCase()[0]#): (#=obj.schedule_timing#)(#=obj.schedule_unit#)
                    </div>
                    <div class="leafTaskContextMenu"
                        dataId="(#=obj.id#)"
                        name="(#=obj.name#)"
                        hierarchy_name="(#=obj.hierarchy_name#)"
                        start=(#=obj.start#)
                        end=(#=obj.end#)
                        type="(#=obj.type#)"
                        priority=(#=obj.priority#)
                        bid_timing=(#=obj.bid_timing#)
                        bid_unit=(#=obj.bid_unit#)
                        schedule_model=(#=obj.schedule_model#)
                        schedule_timing=(#=obj.schedule_timing#)
                        schedule_unit=(#=obj.schedule_unit#)
                        description="(#=obj.description#)"
                        remaining_seconds="(#=obj.remaining_seconds#)"
                        ></div>
                    <div class="milestone (#=obj.startIsMilestone?'active':''#)" ></div>
                    <div class="taskLabel">(#=obj.link()#)</div>
                    <div class="milestone end (#=obj.endIsMilestone?'active':''#)"></div>
                    <div class="taskResourceLabel">(#=obj.getResourcesLinks()#)</div>
                    (#=obj.clippedStart?'<div class="leftArrowHead">&nbsp</div>':''#)
                    (#=obj.clippedEnd?'<div class="rightArrowHead">&nbsp</div>':''#)
                </div>
            </td>
        </tr>
    --></div>

    <div class="__template__" type="TASKBAR_COMPACT"><!--
        <tr class="taskBox" dataId="(#=obj.id#)">
            <td>
                <div class="layout (#=obj.hasExternalDep?'extDep':''#)">
                    <div class="taskProgress" style="width:(#=obj.progress>100?100:obj.progress#)%;"></div>
                    <div class="taskExtraTiming" style="width:(#=(obj.schedule_timing - obj.bid_timing)/obj.schedule_timing*100#)%;;"></div>
                    <div class="taskScheduleModel"
                       style="position: absolute; text-align: center; width: 100%;">
                       (#=obj.link()#) (#=obj.schedule_model.toUpperCase()[0]#): (#=obj.schedule_timing#)(#=obj.schedule_unit#)
                    </div>
                    <div class="leafTaskContextMenu"
                        dataId="(#=obj.id#)"
                        name="(#=obj.name#)"
                        hierarchy_name="(#=obj.hierarchy_name#)"
                        start=(#=obj.start#)
                        end=(#=obj.end#)
                        type="(#=obj.type#)"
                        priority=(#=obj.priority#)
                        schedule_model=(#=obj.schedule_model#)
                        schedule_timing=(#=obj.schedule_timing#)
                        schedule_unit=(#=obj.schedule_unit#)
                        description="(#=obj.description#)"
                        ></div>
                </div>
            </td>
        </tr>
    --></div>

    <div class="__template__" type="TASKBAR_ON_LEFT"><!--
        <tr class="leftArrowHead" dataId="(#=obj.id#)"><td>&nbsp</td></tr>

    --></div>

    <div class="__template__" type="TASKBAR_ON_RIGHT"><!--
        <tr class="rightArrowHead" dataId="(#=obj.id#)"><td>&nbsp</td></tr>
    --></div>

    <div class="__template__" type="PARENTTASKBAR"><!--
        <tr class="parentTaskBox" dataId="(#=obj.id#)">
            <td>
                <div class="layout (#=obj.hasExternalDep?'extDep':''#)">
                    <div class="parentTaskContextMenu" dataId="(#=obj.id#)"></div>
                    <div class="leftPin"></div>
                    <div class="rightPin"></div>
                    <div class="taskLabel">(#=obj.link()#)</div>
                </div>
            </td>
        </tr>
    --></div>

    <div class="__template__" type="TIMELOGBAR"><!--
        <tr class="timeLogBox" dataId="(#=obj.id#)">
            <td>
                <div class="layout">
                    <div class="timeLogContextMenu"
                        dataId="(#=obj.id#)"
                        name="(#=obj.name#)"
                        start=(#=obj.start#)
                        end=(#=obj.end#)
                        task_id=(#=obj.task.id#)
                        task_name="(#=obj.task.name#)"
                        task_type="(#=obj.task.type#)"
                        task_hierarchy_name="(#=obj.task.hierarchy_name#)"
                        ></div>
                </div>
            </td>
        </tr>
    --></div>


    <div class="__template__" type='TASKLINK'><!--
      <a href="javascript:redirectLinkInParent('(#=obj.type.toLowerCase()#)s_content_pane','view/task/(#=obj.id#)');">(#=obj.name#) ((#=obj.type#))</a>
    --></div>

    <div class="__template__" type='RESOURCELINK'><!--
        <a href="javascript:redirectLink('central_content','view/user/(#=obj.id#)');">(#=obj.name#)</a>
    --></div>

    <div class="__template__" type='PROJECTLINK'><!--
        <a href="javascript:redirectLink('central_content','view/project/(#=obj.id#)');">(#=obj.name#) ((#=obj.type#))</a>
    --></div>

</div>

{% block body %}
    <div id='appLayout' class='demoLayout'>
        <div id='header' class='edgePanel' style="overflow: hidden">
            {% block header %}
                <div id='stalker_logo'>
                    <a href="/" style='color: #000000'>STALKER</a>
                </div>

                <div id='stalkerMenuBar' style='color: #000000'></div>

                <div id='mebar'>
                    <div style='color: #000000' id='mebutton'></div>
                </div>

            {% endblock %}
        </div>

        <div style="margin-top: 0" id='central_content' class='centralPanel'>
            {% block content %}
                <div id='main_view'>
                    {% block main_view %}{% endblock %}
                </div>
            {% endblock %}
        </div>

        <div id='footer' class='edgePanel'>
            {% block footer %}
                <div class='footer'>&copy; Copyright 2009-2013, Erkan Ozgur
                                           Yilmaz.
                    <span style='font-size: 12px;'>Stalker Pyramid v{{ stalker_pyramid.__version__ }}</span>
                </div>
            {% endblock %}
        </div>
    </div>


    <script type='text/javascript'>

    // load templates for jQueryGantt
{#    $('#ganttEditorTemplates').loadTemplates();#}

    var redirectLinkInParent = function (targetPane, address) {
        var tab_container = dijit.byId('data_tab_container');
        var contentPane = dijit.byId(targetPane);

        if (contentPane) {
            if (contentPane != tab_container.selectedChildWidget) {
                tab_container.selectChild(contentPane); //Show the selected Tab
            }
        }
        else {
            contentPane = tab_container.selectedChildWidget;
        }

        contentPane.set('href', address);
        contentPane.refresh();
    };

    var redirectLink = function (targetPane, address) {
        var contentPane = dijit.byId(targetPane);
        contentPane.set('href', address);
        contentPane.refresh();
    };

    require([
        'dijit/layout/BorderContainer',
        'dojox/layout/ContentPane',

        'dijit/MenuBar',
        'dijit/MenuBarItem',
        'dijit/MenuSeparator',
        'dijit/PopupMenuBarItem',
        'dijit/PopupMenuItem',
        'dijit/MenuItem',
        'dijit/DropDownMenu',
        'dijit/form/DropDownButton',
        'dijit/TooltipDialog',
        'dijit/popup',

        'dojo/on',

        'dojo/store/JsonRest',
        'dojo/store/Memory',
        'dojo/_base/fx',

        'stalker/dialogs',
        'stalker/dialogCaller',
        'stalker/dialogCreator',
        'stalker/teamMenuCreator',

        'dojo/domReady!'
    ], function (BorderContainer, ContentPane, MenuBar, MenuBarItem,
                 MenuSeparator, PopupMenuBarItem, PopupMenuItem, MenuItem,
                 DropDownMenu, DropDownButton, TooltipDialog, popup, on,
                 JsonRest, Memory, fx, dialogs, dialogCaller, dialogCreator,
                 teamMenuCreator) {

        // ******************************************************************
        // create the BorderContainer and attach it to our appLayout div
        var appLayout = new BorderContainer({
            design: 'headline',
            style: 'padding: 0px',
            splitter: true,
            gutters: false
        }, 'appLayout');


        // ******************************************************************
        // Header
        var header_pane = new ContentPane({
            name: 'header_pane',
            region: 'top',
            style: 'height: 24px; padding: 0px;',
            executeScripts: true
        }, 'header');
        appLayout.addChild(header_pane);

        // ******************************************************************
        // Main Content
        var central_content_pane = new ContentPane({
            name: 'central_content_pane',
            region: 'center',
            style: 'padding: 0px',
            href: 'view/user/{{ logged_in_user.id }}',
            executeScripts: true
        }, 'central_content');
        appLayout.addChild(central_content_pane);


        // ******************************************************************
        // Footer
        var footer_content_pane = new ContentPane({
            name: 'footer_pane',
            region: 'bottom',
            style: 'height: 14px; padding: 0px'
        }, 'footer');
        footer_content_pane.startup();
        appLayout.addChild(footer_content_pane);


        // ******************************************************************
        // MenuBar
        var stalker_MenuBar = new MenuBar({

        }, 'stalkerMenuBar');


        // ******************************************************************
        // HOME

        stalker_MenuBar.addChild(new MenuBarItem({
            label: "HOME ",
            onClick: function () {
                central_content_pane.set(
                        'href',
                        'view/user/{{ logged_in_user.id }}'
                );
                central_content_pane.refresh();
            }
        }));


        // ******************************************************************
        // STUDIO

        var studio_DropDownMenu = new DropDownMenu({

        });

        {% if not studio %}
            {% if has_permission('Create_Studio') %}
                studio_DropDownMenu.addChild(
                        dialogCaller({
                            label: 'Create Studio',
                            dialog_id: 'studio_dialog',
                            content_creator: dialogs.create_studio_dialog,
                            widget_type: 'MenuItem'
                        })
                );
            {% endif %}
        {% else %}
            {% if has_permission('Read_Studio') %}
                studio_DropDownMenu.addChild(
                        new MenuItem({
                            label: '{{ studio.name }}',
                            style: 'font-weight: bold',
                            dataId: '{{ studio.id }}',
                            onClick: function () {
                                central_content_pane.set(
                                        'href',
                                        'view/studio/' + this.get('dataId')
                                );
                                central_content_pane.refresh();
                            }
                        })
                );
            {% endif %}
        {% endif %}





        studio_DropDownMenu.addChild(
                new MenuSeparator({})
        );

        //------------
        // SETTINGS
        var settings_DropDownMenu;


        var create_studio_setting_DropDownMenu = function () {

            if (settings_DropDownMenu == null) {
                settings_DropDownMenu = new DropDownMenu({
                    style: 'display: none;'
                });
            }
        };

        // ------------
        // Filename Template
        {% if has_permission('Create_FilenameTemplate') %}
            create_studio_setting_DropDownMenu();
            settings_DropDownMenu.addChild(
                    dialogCaller({
                        label: 'Filename Template',
                        dialog_id: 'filename_template_dialog',
                        content_creator: dialogs.create_filename_template_dialog,
                        widget_type: 'MenuItem'
                    })
            );
        {% endif %}

        // ------------
        // Image Format
        {% if has_permission('Create_ImageFormat') %}
            create_studio_setting_DropDownMenu();
            settings_DropDownMenu.addChild(
                    dialogCaller({
                        label: 'Image Format',
                        dialog_id: 'image_format_dialog',
                        content_creator: dialogs.create_image_format_dialog,
                        widget_type: 'MenuItem'
                    })
            );
        {% endif %}

        // -------
        // Repository
        {% if has_permission('Create_Repository') %}
            create_studio_setting_DropDownMenu();
            settings_DropDownMenu.addChild(
                    dialogCaller({
                        label: 'Repository',
                        dialog_id: 'repository_dialog',
                        content_creator: dialogs.create_repository_dialog,
                        widget_type: 'MenuItem'
                    })
            );
        {% endif %}
        // -------
        // Status
        {% if has_permission('Create_Status') %}
            create_studio_setting_DropDownMenu();
            settings_DropDownMenu.addChild(
                    dialogCaller({
                        label: 'Status',
                        dialog_id: 'status_dialog',
                        content_creator: dialogs.create_status_dialog,
                        widget_type: 'MenuItem'
                    })
            );
        {% endif %}

        // -------
        // Status List
        {% if has_permission('Create_StatusList') %}
            create_studio_setting_DropDownMenu();
            settings_DropDownMenu.addChild(
                    dialogCaller({
                        label: 'Status List',
                        dialog_id: 'status_list_dialog',
                        content_creator: dialogs.create_status_list_dialog,
                        widget_type: 'MenuItem'
                    })
            );
        {% endif %}

        // -------
        // Structure
        {% if has_permission('Create_Structure') %}
            create_studio_setting_DropDownMenu();
            settings_DropDownMenu.addChild(
                    dialogCaller({
                        label: 'Structure',
                        dialog_id: 'structure_dialog',
                        content_creator: dialogs.create_structure_dialog,
                        widget_type: 'MenuItem'
                    })
            );
        {% endif %}


        if (settings_DropDownMenu != null) {
            studio_DropDownMenu.addChild(new PopupMenuItem({
                label: "New",
                popup: settings_DropDownMenu
            })
            );
        }

        stalker_MenuBar.addChild(new PopupMenuBarItem({
            label: "STUDIO",
            popup: studio_DropDownMenu
        }));


        // ******************************************************************
        // PROJECTS

        var projects_DropDownMenu = new DropDownMenu({

        });

        stalker_MenuBar.addChild(
                new PopupMenuBarItem({
                    label: "PROJECTS",
                    popup: projects_DropDownMenu
                })
        );

        // Project Menu
        var create_project_setting_DropDownMenu = function (pID) {

            var project_setting_DropDownMenu = new DropDownMenu({

            });


            // --------
            // View Project

            project_setting_DropDownMenu.addChild(
                    new MenuItem({
                        label: 'View',
                        dataId: pID,
                        onClick: function () {
                            central_content_pane.set(
                                    'href',
                                    'view/project/' + this.get('dataId')
                            );
                            central_content_pane.refresh();
                        }
                    })
            );
            var needSeparator1 = false;
            var needSeparator2 = false;

            // --------
            {% if has_permission('Update_Project') %}
                // Update Project
                project_setting_DropDownMenu.addChild(
                        dialogCaller({
                            label: 'Update',
                            dialog_id: 'project_dialog',
                            content_creator: dialogs.update_project_dialog,
                            widget_type: 'MenuItem',
                            data_id: pID

                        })
                );
                needSeparator1 = true;
                needSeparator2 = true;

            {% endif %}



            // --------
            {% if has_permission('Create_Asset') %}

                // Asset

                if (needSeparator1) {
                    project_setting_DropDownMenu.addChild(
                            new MenuSeparator({})
                    );
                    needSeparator1 = false;
                }

                project_setting_DropDownMenu.addChild(
                        dialogCaller({
                            label: 'New Asset',
                            dialog_id: 'asset_dialog',
                            content_creator: dialogs.create_asset_dialog,
                            widget_type: 'MenuItem',
                            data_id: pID

                        })
                );

                needSeparator2 = true;
            {% endif %}

            // --------
            {% if has_permission('Create_Sequence') %}
                // Sequence
                if (needSeparator1) {
                    project_setting_DropDownMenu.addChild(
                            new MenuSeparator({})
                    );
                    needSeparator1 = false;
                }
                project_setting_DropDownMenu.addChild(
                        dialogCaller({
                            label: 'New Sequence',
                            dialog_id: 'sequence_dialog',
                            content_creator: dialogs.create_sequence_dialog,
                            widget_type: 'MenuItem',
                            data_id: pID
                        })
                );

                needSeparator2 = true;
            {% endif %}

            // ----
            {% if has_permission('Create_Shot') %}
                // Shot
                if (needSeparator1) {
                    project_setting_DropDownMenu.addChild(
                            new MenuSeparator({})
                    );
                    needSeparator1 = false;

                }
                project_setting_DropDownMenu.addChild(
                        dialogCaller({
                            label: 'New Shot',
                            dialog_id: 'shot_dialog',
                            content_creator: dialogs.create_shot_dialog,
                            widget_type: 'MenuItem',
                            data_id: pID
                        })
                );

                needSeparator2 = true;
            {% endif %}

            {% if has_permission('Update_User') %}
                if (needSeparator2) {
                    project_setting_DropDownMenu.addChild(
                            new MenuSeparator({})
                    );
                }

                project_setting_DropDownMenu.addChild(
                        dialogCaller({
                            label: 'Append User',
                            dialog_id: 'append_user_dialog',
                            content_creator: dialogs.append_user_dialog,
                            widget_type: 'MenuItem',
                            data_id: pID
                        })
                );
            {% endif %}

            return project_setting_DropDownMenu;

        };

        var projectPopupMenuItem = function (mItem, dLabel, dId) {

            if (mItem.classname != 'PopupMenuItem') {

                return new PopupMenuItem({
                    label: dLabel,
                    dataId: dId,
                    popup: create_project_setting_DropDownMenu(dId)
                });

            }
            else {

                return mItem;
            }

        };


        var projectMenuItemCreator = function (dLabel, dId) {

            var projectMenuItem = new MenuItem({
                label: dLabel,
                dataId: dId,
                onClick: function () {
                    central_content_pane.set(
                            'href',
                            'view/project/' + this.get('dataId')
                    );
                    central_content_pane.refresh();
                }
            });


            {% if has_permission('Update_Project') %}
                projectMenuItem = projectPopupMenuItem(projectMenuItem, dLabel, dId);
            {% endif %}


            // -----
            {% if has_permission('Create_Asset') %}
                // Asset
                projectMenuItem = projectPopupMenuItem(projectMenuItem, dLabel, dId);
            {% endif %}

            // --------
            {% if has_permission('Create_Sequence') %}
                // Sequence
                projectMenuItem = projectPopupMenuItem(projectMenuItem, dLabel, dId);
            {% endif %}

            // ----
            {% if has_permission('Create_Shot') %}
                // Shot
                projectMenuItem = projectPopupMenuItem(projectMenuItem, dLabel, dId);

            {% endif %}

            return projectMenuItem;

        };


        var target = 'get/projects_byEntity/{{ logged_in_user.id }}';
        {% if has_permission('List_Project') %}
            target = 'get/projects'
        {% endif %}

        // Project Memory
        var projects_memory = new JsonRest({
            target: target
        });

        // Projects Updater
        var projects_DropDownMenu_updater = function () {
            // delete the current items
            var items = projects_DropDownMenu.getChildren();
            for (var i = 0; i < items.length; i++) {
                items[i].destroyRecursive();
            }

            // query new items
            var result = projects_memory.query().then(function (data) {
                for (var i = 0; i < data.length; i++) {
                    projects_DropDownMenu.addChild(projectMenuItemCreator(data[i].name, data[i].id));
                }
                var needSeparator = false;
                if (i > 0) {
                    needSeparator = true;

                }

                {% if has_permission('Create_Project') %}
                    if (needSeparator) {
                        projects_DropDownMenu.addChild(
                                new MenuSeparator({})
                        );
                    }
                    projects_DropDownMenu.addChild(
                            dialogCaller({
                                label: 'New Project',
                                dialog_id: 'project_dialog',
                                content_creator: dialogs.create_project_dialog,
                                widget_type: 'MenuItem',
                                related_field_updater: projects_DropDownMenu_updater
                            })
                    );
                {% endif %}



                // -----
                {% if has_permission('Create_Asset') %}
                    if (needSeparator) {
                        projects_DropDownMenu.addChild(
                                new MenuSeparator({})
                        );
                        needSeparator = false;
                    }
                    // Asset
                    projects_DropDownMenu.addChild(
                            dialogCaller({
                                label: 'New Asset',
                                dialog_id: 'asset_dialog',
                                content_creator: dialogs.create_asset_dialog,
                                widget_type: 'MenuItem'

                            })
                    );
                {% endif %}

                // --------
                {% if has_permission('Create_Sequence') %}
                    // Sequence
                    if (needSeparator) {
                        projects_DropDownMenu.addChild(
                                new MenuSeparator({})
                        );
                        needSeparator = false;
                    }

                    projects_DropDownMenu.addChild(
                            dialogCaller({
                                label: 'New Sequence',
                                dialog_id: 'sequence_dialog',
                                content_creator: dialogs.create_sequence_dialog,
                                widget_type: 'MenuItem'
                            })
                    );
                {% endif %}

                // ----
                {% if has_permission('Create_Shot') %}
                    // Shot

                    if (needSeparator) {
                        projects_DropDownMenu.addChild(
                                new MenuSeparator({})
                        );
                        needSeparator = false;
                    }

                    projects_DropDownMenu.addChild(
                            dialogCaller({
                                label: 'New Shot',
                                dialog_id: 'shot_dialog',
                                content_creator: dialogs.create_shot_dialog,
                                widget_type: 'MenuItem'
                            })
                    );
                {% endif %}


            });
        };
        projects_DropDownMenu_updater();


        // ******************************************************************
        // CREW - Users / Departments / Groups
        var crew_DropDownMenu = new DropDownMenu();

        stalker_MenuBar.addChild(new PopupMenuBarItem({
            label: 'CREW',
            popup: crew_DropDownMenu
        }));

        {% if has_permission('List_User') %}
            teamMenuCreator({
                team_is_singular: true,
                menu_to_attach: crew_DropDownMenu,
                entity_type_name: 'user',
                view_entity_url: 'view/user/',
                query_entity_url: 'get/users',
                content_pane_to_update: central_content_pane,
                new_team_dialog_id: 'user_dialog',
                new_team_dialog_content_creator: dialogs.create_user_dialog,
                allow_create_new: {%  if has_permission('Create_User') %}
                    true {% else %} false {% endif %}
            });
        {% endif %}

        {% if has_permission('List_Department') %}
            teamMenuCreator({
                menu_to_attach: crew_DropDownMenu,
                entity_type_name: 'department',
                view_entity_url: 'view/department/',
                query_entity_url: 'get/departments',
                content_pane_to_update: central_content_pane,
                new_team_dialog_id: 'department_dialog',
                new_team_dialog_content_creator: dialogs.create_department_dialog,
                allow_create_new: {%  if has_permission('Create_Department') %}
                    true {% else %} false {% endif %}
            });
        {% endif %}

        {% if has_permission('List_Group') %}
            teamMenuCreator({
                menu_to_attach: crew_DropDownMenu,
                entity_type_name: 'group',
                view_entity_url: 'view/group/',
                query_entity_url: 'get/groups',
                content_pane_to_update: central_content_pane,
                new_team_dialog_id: 'group_dialog',
                new_team_dialog_content_creator: dialogs.create_group_dialog,
                allow_create_new: {%  if has_permission('Create_Group') %}
                    true {% else %} false {% endif %}
            });
        {% endif %}

        stalker_MenuBar.startup();


        // ******************************************************************
        // ME BAR
        var mebar_tooltipDialog = new TooltipDialog({
            id: 'mebar_tooltipDialog',
            style: 'width: 250px; height: 100%',
            href: '/me_menu',
            onMouseLeave: function () {
                mebar_tooltipDialog.set('visible', false);
                popup.close(mebar_tooltipDialog);
            }
        });
        mebar_tooltipDialog.startup();

        var settings_button = dialogCaller({
            label: 'Update',
            dialog_id: 'update_user_dialog',
            content_creator: dialogs.update_user_dialog,
            attach_to: 'settings_button',
            data_id: '{{ logged_in_user.id }}'
        });
        settings_button.startup();


        //
        var mebar_dropDownButton = DropDownButton({
            label: '{{ logged_in_user.name }}',
            dropDown: mebar_tooltipDialog,
            style: 'margin-top: 0px; margin-bottom: 0px; color: #000000'
        }, 'mebutton');
        mebar_dropDownButton.startup();

        // ******************************************************************
        // startup app layout
        appLayout.startup();

        // load user home by default
        central_content_pane.set(
                'href',
                'view/user/{{ logged_in_user.id }}'
        );
        central_content_pane.refresh();
    });
    </script>
{% endblock %}
</body>
</html>
