
{% raw %}
<script id="tmpl_projectEditRow" type="text/x-dot-template">
    <div class="projectEditRow"
         dataId="{{=it.id}}"
         name="{{=it.name}}"
         start={{=it.start}}
         end={{=it.end}}
         type="{{=it.type}}"
         hasChildren={{=it.hasChildren}}><a href="{{=it.link}}">{{=it.name}} ({{=it.type}})</a>
    </div>
</script>

<script id="tmpl_projectBar" type="text/x-dot-template">
    <div class="projectBox" projectId="{{=it.id}}">
        <div class="layout">
            <div class="projectLabel">{{=it.link()}}</div>
            <div class="projectContextMenu" dataId="{{=it.id}}"></div>
        </div>
    </div>
</script>


<script id="tmpl_taskBar" type="text/x-dot-template">
    <div class="taskBox" dataId="{{=it.id}}">
        <div class="layout {{=it.hasExternalDep?'extDep':''}}">
            <div class="taskProgress"
                 style="width:{{=it.progress > 100 ? 100 : it.progress }}%;"></div>
            <div class="taskExtraTiming"
                 style="width:{{=(it.schedule_timing - it.bid_timing)/it.schedule_timing*100}}%;"></div>
            <div class="taskScheduleModel">
                {{=it.schedule_model.toUpperCase()[0]}}:
                {{=it.schedule_timing}}{{=it.schedule_unit}}
            </div>
            <div class="taskLabel">{{=it.link()}}</div>
            <div class="milestone end {{=it.endIsMilestone ? 'active' : ''}}"></div>
            <div class="taskResourceLabel">{{=it.getResourcesLinks()}}
            </div>
            {{=it.clippedStart?'
            <div class="leftArrowHead">&nbsp</div>
            ':''}}
            {{=it.clippedEnd?'
            <div class="rightArrowHead">&nbsp</div>
            ':''}}
            <div class="leafTaskContextMenu"
                 dataId="{{=it.id}}"
                 name="{{=it.name}}"
                 hierarchy_name="{{=it.hierarchy_name}}"
                 start={{=it.start}}
                 end={{=it.end}}
                 type="{{=it.type}}"
                 priority={{=it.priority}}
                 bid_timing={{=it.bid_timing}}
                 bid_unit={{=it.bid_unit}}
                 schedule_model={{=it.schedule_model}}
                 schedule_timing={{=it.schedule_timing}}
                 schedule_unit={{=it.schedule_unit}}
                 description="{{=it.description}}"
                 remaining_seconds="{{=it.remaining_seconds}}"
                 resources="{{=it.getResourcesStr()}}"
                 responsible_id="{{=it.responsible.id}}"
                 responsible_name="{{=it.responsible.name}}"
                    ></div>
        </div>
    </div>
</script>

<script id="tmpl_resourceBar" type="text/x-dot-template">
    <div class="resourceBox" dataId="{{=it.id}}">
        <div class="layout">
            <div class="resourceResourceLabel">{{=it.link()}}</div>
        </div>
    </div>
</script>

<script id='tmpl_leafTaskToolTip' type='text/x-dot-template'>
    <table>
        <thead style="text-align: center">
        <h2>{{=it.name}} ({{=it.type}})</h2>
        <h4>{{=it.hierarchy_name}}</h4>
        </thead>

        <tbody>
        <tr>
            <td class="label_column">Id</td>
            <td class="input_column">{{=it.dataId}}</td>
        </tr>
        <tr>
            <td class="label_column">Priority</td>
            <td class="input_column">{{=it.priority}}</td>
        </tr>
        <tr>
            <td class="label_column">BID</td>
            <td class="input_column">{{=it.bid_timing}} {{=it.bid_unit}}
            </td>
        </tr>
        <tr>
            <td class="label_column">{{=it.schedule_model}}</td>
            <td class="input_column">{{=it.schedule_timing}}
                {{=it.schedule_unit}}
            </td>
        </tr>
        <tr>
            <td class="label_column">Start</td>
            <td class="input_column">{{=it.start.format("yyyy-mm-dd
                HH:00")}}
            </td>
        </tr>
        <tr>
            <td class="label_column">End</td>
            <td class="input_column">{{=it.end.format("yyyy-mm-dd
                HH:00")}}
            </td>
        </tr>
        <tr>
            <td class="label_column">Description</td>
            <td class="input_column">{{=it.description}}</td>
        </tr>
        <tr>
            <td class="label_column">Remaining Time</td>
            <td class="input_column">{{=it.remaining_seconds}}</td>
        </tr>
        <tr>
            <td class="label_column">Responsible</td>
            <td class="input_column">{{=it.responsible.name}}</td>
        </tr>
        </tbody>
    </table>
</script>

<script id="tmpl_taskEditRow" type="text/x-dot-template">
    <a href='/tasks/{{=it.id}}/view'

       data-toggle='tooltip'
       data-placement='top'
       title
       data-original-title='test tooltip'

       name="{{=it.name}}"
       start={{=it.start}}
       end={{=it.end}}
       type="{{=it.type}}"
    {{ if (!it.hasChildren) { }}
    responsible_id="{{=it.responsible.id}}"
    responsible_name="{{=it.responsible.name}}"
    {{ } }}
    hasChildren={{=it.hasChildren}}>{{=it.name}} ({{=it.type}})</a>
</script>


<script id="tmpl_parentTaskEditRow" type="text/x-dot-template">
    <div class="{{=it.contextMenuClass}}"
         dataId="{{=it.id}}"
         name="{{=it.name}}"
         start={{=it.start}}
         end={{=it.end}}
         type="{{=it.type}}"
         hasChildren={{=it.hasChildren}}><a href="{{=it.link}}">{{=it.name}} ({{=it.type}})</a>
    </div>
</script>


<script id="tmpl_parentTaskBar" type="text/x-dot-template">
    <div class="parentTaskBox" dataId="{{=it.id}}">
        <div class="layout {{=it.hasExternalDep?'extDep':''}}">
            <div class="leftPin"></div>
            <div class="rightPin"></div>
            <div class="taskLabel">{{=it.link()}}</div>
            <div class="parentTaskContextMenu" dataId="{{=it.id}}"></div>
        </div>
    </div>
</script>

<script id="tmpl_taskLink" type="text/x-dot-template">
    <a href="/tasks/{{=it.id}}/view">{{=it.name}} ({{=it.type}})</a>
</script>

<script id='tmpl_resourceLink' type='text/x-dot-template'>
    <a href="/users/{{=it.id}}/view">{{=it.name}}</a>
</script>

<script id="tmpl_projectLink" type="text/x-dot-template">
    <a href="/projects/{{=it.id}}/view">{{=it.name}} ({{=it.type}})</a>
</script>

<script id='tmpl_entityNameField' type="text/x-dot-template">
    <a href="{{=it.address}}">{{=it.name}} ({{=it.code}})</a>
</script>

<script id='tmpl_userNameField' type="text/x-dot-template">
    <a href="{{=it.address}}>{{=it.user_name}}</a>
</script>

<script id='tmpl_departmentField' type="text/x-dot-template">
    <a href="{{=it.address}}">{{=it.name}}</a>
</script>

<script id='tmpl_groupField' type="text/x-dot-template">
    <a href="{{=it.address}}">{{=it.name}}</a>
</script>

<script id='tmpl_ticketNameField' type="text/x-dot-template">
    <a href="{{=it.address}}">#{{=it.number}}</a>
</script>

<script id='tmpl_referenceLink' type='text/x-dot-template'>
    <a href="javascript:lightBox('{{=it.original_filename}}', '{{=it.full_path}}');">{{=it.original_filename}}</a>
</script>
{% endraw %}

<script type='text/javascript'>
    // ************************************************************************
    // load templates with doT.js
    var templates = {};

    templates.projectBar = doT.template(document.getElementById('tmpl_projectBar').text);
    templates.parentTaskBar = doT.template(document.getElementById('tmpl_parentTaskBar').text);
    templates.taskBar = doT.template(document.getElementById('tmpl_taskBar').text);
    templates.resourceBar = doT.template(document.getElementById('tmpl_resourceBar').text);

    templates.projectEditRow = doT.template(document.getElementById('tmpl_projectEditRow').text);
    templates.parentTaskEditRow = doT.template(document.getElementById('tmpl_parentTaskEditRow').text);
    templates.taskEditRow = doT.template(document.getElementById('tmpl_taskEditRow').text);

    templates.projectLink = doT.template(document.getElementById('tmpl_projectLink').text);
    templates.taskLink = doT.template(document.getElementById('tmpl_taskLink').text);
    templates.resourceLink = doT.template(document.getElementById('tmpl_resourceLink').text);

    templates.leafTaskToolTip = doT.template(document.getElementById('tmpl_leafTaskToolTip').text);

    // for DGrid Headers
    templates.entityNameField = doT.template(document.getElementById('tmpl_entityNameField').text);
    templates.userNameField = doT.template(document.getElementById('tmpl_userNameField').text);
    templates.departmentField = doT.template(document.getElementById('tmpl_departmentField').text);
    templates.groupField = doT.template(document.getElementById('tmpl_groupField').text);
    templates.ticketNameField = doT.template(document.getElementById('tmpl_ticketNameField').text);
    templates.referenceLink = doT.template(document.getElementById('tmpl_referenceLink').text);

</script>

<div class="row-fluid">
    <div class="span12">
        <!--PAGE CONTENT BEGINS-->

        <div class="left">

            <div class="btn-toolbar">

                <div class="input-prepend"
                     style="height: 30px;
                            margin-bottom: 0px;">
                    <input id='start_end_date_range_picker'
                           name='start_and_end_dates'
                           type="text"
                           data-date-format="yyyy-mm-dd"
                           placeholder="Start & End Dates">
                        <span class="add-on">
                            <i class="icon-calendar"></i>
                        </span>
                </div>

                <div class="input-prepend"
                     style="height: 30px;
                            margin-bottom: 0px;
                            margin-left: 7px;
                            margin-right: 7px;
                            ">
                    <select id='zoom_level'
                           name='start_and_end_dates'>
                        <option value="h">Hours</option>
                        <option value="d">Days</option>
                        <option value="w" selected>Weeks</option>
                        <option value="m">Months</option>
                        <option value="y">Years</option>
                    </select>
                </div>

                <div id="resource_update_button" class="btn-group">
                    <button class="btn btn-small btn-warning">
                        <span class="icon-refresh bigger-120"></span>
                        Update
                    </button>
                </div>

                <div id="resource_reload_button" class="btn-group">
                    <button class="btn btn-small btn-success">
                        <span class="icon-retweet bigger-120"></span>
                        Reload
                    </button>
                </div>

                <div id="resource_redraw_button" class="btn-group">
                    <button class="btn btn-small btn-info">
                        <span class="icon-undo bigger-120"></span>
                        Redraw
                    </button>
                </div>

                <div id="resource_go_to_today_button" class="btn-group">
                    <button class="btn btn-small btn-default">
                        <i class="icon-arrow-right bigger-120"></i>
                        Go To Today
                    </button>
                    <div id="resource_scroll_to_button" class="hidden" start="0"></div>
                </div>
            </div>

            <div class="row-fluid">
                <div id="{{ entity.entity_type }}_{{ entity.id }}_resource_grid"
                     class='resource_chart'
                     style='height: 700px'></div>
            </div>
        </div>
        <!--PAGE CONTENT ENDS-->
    </div>
    <!--/.span-->
</div>


<script type='text/javascript'
        data-dojo-config="async: true, parseOnLoad: true"
        src='{{ request.static_url("stalker_pyramid:static/dojo/dojo.js") }}'>
</script>

<script type='text/javascript'
        src='{{ request.static_url("stalker_pyramid:static/stalker/js/Studio.js") }}'>
</script>

<script src='{{ request.static_url("stalker_pyramid:static/ace/js/date-time/daterangepicker.min.js") }}'></script>



<script type="text/javascript">

require([
    'dojo/store/Cache',
    'dojo/store/Memory',
    'dojo/store/JsonRest',

    "dgrid/List",
    "dgrid/Grid",
    'dojox/data/JsonRestStore',

    'stalker/js/ResourceGrid',

    'dojo/domReady!'
], function (Cache, Memory, JsonRest, List, Grid, JsonRestStore, ResourceGrid){

    // The Memory
    var target = '{{ request.route_url('get_resource', id=entity.id) }}';
    {% if entity.entity_type == "User" %}
        console.debug('entity_type: User');
    var target = '{{ request.route_url('get_resource', id=entity.id) }}';
        console.debug('entity_type:', '{{ entity.entity_type }}');
    {% elif entity.entity_type == "Department" %}
        var target = '{{ request.route_url('get_resource', id=entity.id) }}';
    {% endif %}

    var resources_memory_store = new Memory();
    console.debug('target:', target);

    var resources_jsonRest_store = new JsonRest({
        target: target,
        getChildren: function (parent, options) {
            return this.query({parent_id: parent.id}, options);
        },
        mayHaveChildren: function (parent) {
            return parent.hasChildren;
        }
    });
    var tasks_cache_store = new Cache(resources_jsonRest_store, resources_memory_store);

    // allow the resource_grid to resize with the window
    $(window).on('resize', function(){
        var resource_grid_height = $(window).height() - 230;
        $('#'+'{{ entity.entity_type }}_{{ entity.id }}_resource_grid').css({height: resource_grid_height});
    });
    $(window).trigger('resize');

    var resource_grid = new ResourceGrid({
        id: '{{ entity.entity_type }}_{{ entity.id }}_resource_grid',
        width: '100%',
        autoHeight: true,
        store: tasks_cache_store,
        query: {
            // initialize with the entity itself
            id: {{ entity.id }}
        },
        loadingMessage: "<div style='float: left' class='dijitIconLoading'>&nbsp</div><div>Loading</div>",
        noDataMessage: "",
        pageSkip: 0,
        cellNavigation: false
    }, '{{ entity.entity_type }}_{{ entity.id }}_resource_grid');
    resource_grid.startup();

    // ceter on today
    setTimeout(
        function () {
            resource_column.centerOnToday();
        },
        0
    );

    // get the resource column
    var resource_column = resource_grid.columnSets[1][0][0];

    // Update Button
    $("#resource_update_button").on('click', function(e){
        // update date values
        var start_and_end_dates_as_string = $('#start_end_date_range_picker').val();
        var dates = start_and_end_dates_as_string.split(' - ');
        var start_date = moment(dates[0], 'MM-DD-YYYY').startOf('day');
        var end_date = moment(dates[1], 'MM-DD-YYYY').endOf('day');

        // get zoom level
        var zoom_level = $('#zoom_level').val();

        // get the total amount of element going to be rendered
        var element_count = resource_column.guess_element_count(+start_date, +end_date, zoom_level);

        var do_update = function(){
            resource_column.start = +start_date;
            resource_column.end   = +end_date;
            resource_column.scale = zoom_level; 
            resource_column.reload();
            resource_column.refresh();
        }

        if (element_count > 100){
            // confirm the user that it is going to take too much time
            bootbox.confirm(
                '<div><p><strong>' + element_count +
                ' elements</strong> per row are going to be rendered'+
                '<br><br>Which will take long,' +
                '<br><br>Is that ok?',
            function(result){
                if (result){
                    do_update();
                }
            });
        } else {
            do_update();
        }

    });


    // Reload Button
    $("#resource_reload_button").on('click', function(e){
        e.preventDefault();
        e.stopPropagation();
        resource_column.reload();
    });

    // Refresh Button
    $("#resource_redraw_button").on('click', function(e){
        e.preventDefault();
        e.stopPropagation();
        resource_column.refresh();
    });

    // scroll to button
    $("#resource_scroll_to_button").on('click', function(e){
        var start = $(this).attr('start');
        resourse_column.scrollToDate(start);
        e.preventDefault();
        e.stopPropagation();
    });

    // Schedule
    {% if has_permission('Update_Task') %}
        $('#resourse_schedule_tasks_button').on('click', function(){
            var dialog = $( "#schedule-dialog-message" ).dialog({
                modal: true,
                title: "Scheduling Tasks...",
                title_html: true,
                height: 70,
                width: 350
            });

            $.post(
                '{{ request.route_url("auto_schedule_tasks") }}'
            ).done(function(data){
                var message = '<div>' + data + '</div>';
                bootbox.alert(message);
                $('.bootbox').prepend('<div class="modal-header alert-success"><strong>Success</strong></div>');
            }).fail(function(jqXHR){
                var message = '<div>' + jqXHR.responseText + '</div>';
                bootbox.alert(message);
                $('.bootbox').prepend('<div class="modal-header alert-danger"><strong>Fail</strong></div>');
            }).always(function(){
                dialog.dialog("close");
                resource_column.refresh();
            })
            
        });
    {% endif %}

    $('#resource_go_to_today_button').on('click', function(){
       resource_column.centerOnToday(); 
    });
});
</script>


<script>
    {# ***************************************************************** #}
    {# Start & End Date Picker #}

    $(function () {
        // initialize date picker
        var start_end_date_range_picker = $('#start_end_date_range_picker').daterangepicker();

        // also update the icon
        start_end_date_range_picker.next().on('click', function () {
            $(this).prev().focus();
        });

        // fix z-index of the container
        // start_end_date_range_picker.data().daterangepicker.container.css({'z-index': 1060});

        var start_date = moment().subtract(6, 'month').startOf('day');
        var end_date = moment().add(6, 'month').endOf('day');
        start_end_date_range_picker.val(
            start_date.format('MM/DD/YYYY') + ' - ' + end_date.format('MM/DD/YYYY')
        );

        start_end_date_range_picker.data().daterangepicker.updateFromControl();

        // TODO: Change the listener action type
        start_end_date_range_picker.on('shown', function (e) {
            e.stopPropagation();
        });
        start_end_date_range_picker.on('hidden', function (e) {
            e.stopPropagation();
        });
    });

</script>
