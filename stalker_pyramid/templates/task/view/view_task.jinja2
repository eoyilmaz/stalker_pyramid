{% extends "base.jinja2" %}

{#PRE-HEADER #}
{% block pre_header %}

    <link rel="stylesheet"
          href='{{ request.static_url("stalker_pyramid:static/ace/css/fullcalendar.css") }}'/>
    <link rel="stylesheet"
          href='{{ request.static_url("stalker_pyramid:static/ace/css/bootstrap-timepicker.css") }}'/>
    <link rel="stylesheet"
          href='{{ request.static_url("stalker_pyramid:static/ace/css/datepicker.css") }}'/>
    <link rel="stylesheet"
          href='{{ request.static_url("stalker_pyramid:static/ace/css/daterangepicker.css") }}'/>
    <link rel="stylesheet"
          href='{{ request.static_url("stalker_pyramid:static/ace/css/jquery.gritter.css") }}'/>
    <link rel="stylesheet"
          href='{{ request.static_url("stalker_pyramid:static/ace/css/jquery-ui-1.10.3.custom.min.css") }}'/>
    <link rel="stylesheet"
          href='{{ request.static_url("stalker_pyramid:static/ace/css/select2.css") }}'/>
    <link rel="stylesheet"
          href='{{ request.static_url("stalker_pyramid:static/ace/css/bootstrap-editable.css") }}'/>

    {% include 'charts/chart_preheader.jinja2' %}

{% endblock pre_header %}

{#SIDEBAR#}
{% block sidebar %}

    {% include 'sidebar.jinja2' %}
{% endblock sidebar %}

{# BREADCRUMBS #}
{% block breadcrumbs %}
    {% set page_title='Dashboard' %}
    {% include 'breadcrumb/breadcrumbs.jinja2' %}
{% endblock breadcrumbs %}

{#PAGE-CONTENT#}
{% block page_content %}
    <div class="row-fluid">
    <div class="widget-box transparent invoice-box">

    <div class="widget-header widget-header-large ">
        <h3 class="position-relative ">
            <i class="icon-tasks"></i>
            {{ entity.name }}
            <i class="icon-double-angle-right"></i>
            <small class="grey"> # {{ entity.review_number }}</small>

        </h3>

        <div class="widget-toolbar no-border invoice-info">
            <span class="invoice-info-label">Status:</span>
            <span class="label label-{{ entity.status.html_class }}">{{ entity.status.name }}</span>
            <br>

            <div class="progress progress-mini progress-success progress-striped {% if entity.status.code == 'WIP' %}active{% endif %}"
                 style="width: 120px;"
                 data-percent="{{ "%2.1f" | format(entity.percent_complete) }}%">
                <div class="bar"
                     style="width: {{ entity.percent_complete }}%;"></div>
            </div>
        </div>
        <div class="widget-toolbar hidden-480">
            <a href="#">
                <i class="icon-print"></i>
            </a>
        </div>
    </div>

    <div class="widget-body">

    <div class="widget-main">

    <div class="row-fluid">

    <div class="span8">

    <div class="row-fluid">

        <div class="span2">

            {% include 'components/avatar.jinja2' %}

        </div>

        <div class="span7">

            <ul class="unstyled spaced  pull-left">
                <li>
                    <h5>
                        <strong>
                            <span class="date">{{ entity.start }}</span>
                            <i class="icon-long-arrow-right blue"></i>
                            <span class="date">{{ entity.end }}</span>
                        </strong>
                    </h5>
                </li>

                <li>

                    <b>Type
                        : </b> {{ entity.type.name }}
                </li>
                <li>

                    <b>Created By
                        : </b> {{ entity.created_by.name }}
                </li>
                <li>
                    <b>Updated By
                        : </b> {{ entity.updated_by.name }}
                </li>


                {#                <li>#}
                {#                    <div class="btn-toolbar">#}
                {#                        {% if has_permission('Update_Task') %}#}
                {##}
                {#                            <button id='task_update_button'#}
                {#                                    class='btn btn-mini btn-info'#}
                {#                                    data-target="#dialog_template"#}
                {#                                    data-toggle="modal"#}
                {#                                    data-keyboard="false"#}
                {#                                    href='{{ request.route_url("update_task_dialog", id=entity.id) }}'#}
                {#                                    >#}
                {#                                <i class="icon-edit"></i>#}
                {#                                Update#}
                {#                            </button>#}
                {##}
                {#                        {% endif %}#}
                {#                        #}
                {#                                                        {% if logged_in_user in entity.responsible and entity.status.code == 'PREV' %}#}
                {#                        #}
                {#                                                            <button id='task_review_button'#}
                {#                                                                    class='btn btn-mini btn-success'#}
                {#                                                                    data-target="#dialog_template"#}
                {#                                                                    data-toggle="modal"#}
                {#                                                                    data-keyboard="false"#}
                {#                                                                    href='{{ request.route_url("review_task_dialog", id=entity.id) }}'#}
                {#                                                                    >#}
                {#                                                                <i class="icon-comments"></i>#}
                {#                                                                Review#}
                {#                                                            </button>#}
                {#                        #}
                {#                                                        {% endif %}#}
                {#                        {% if (logged_in_user in entity.resources or logged_in_user in entity.responsible) and entity.status.code == 'WIP' and entity.is_leaf %}#}
                {##}
                {#                            <div class="btn-group">#}
                {#                                <button data-toggle="dropdown"#}
                {#                                        class="btn btn-small btn-warning dropdown-toggle">#}
                {#                                    Request Review#}
                {#                                    <span class="caret"></span>#}
                {#                                </button>#}
                {##}
                {#                                <ul class="dropdown-menu dropdown-warning">#}
                {#                                    <li>#}
                {#                                        <a data-target="#dialog_template"#}
                {#                                           data-toggle="modal"#}
                {#                                           data-keyboard="false"#}
                {#                                           href='/tasks/{{ entity.id }}/request_review/dialog?came_from={{ request.current_route_path() }}&request_review_mode=Progress'>Progress</a>#}
                {#                                    </li>#}
                {#                                    <li>#}
                {#                                        <a data-target="#dialog_template"#}
                {#                                           data-toggle="modal"#}
                {#                                           data-keyboard="false"#}
                {#                                           href='/tasks/{{ entity.id }}/request_review/dialog?came_from={{ request.current_route_path() }}&request_review_mode=Final'>Final</a>#}
                {#                                    </li>#}
                {##}
                {##}
                {#                                </ul>#}
                {#                            </div><!--/btn-group-->#}
                {##}
                {#                        {% endif %}#}
                {##}
                {#                    </div>#}
                {#                </li>#}
            </ul>

        </div>

        <div class="span3">

            <div class="pull-right alert alert-block alert-info">
                <ul class="unstyled spaced">
                    <li>

                        <b>Schedule Hours
                            : </b> {{ entity.schedule_seconds/3600 }}
                        h
                    </li>
                    <li>
                        <b>Total Logged Hours
                            : </b> {{ entity.total_logged_seconds/3600 }}
                        h
                    </li>
                    <li>
                        <b>Hours to Complete
                            : </b> {{ (entity.schedule_seconds - entity.total_logged_seconds)/3600 }}
                        h
                    </li>
                </ul>
                {#                                    <div class="pull-left" id="pie_chart"#}
                {#                                         style="width: 180px; height: 180px;"></div>#}
            </div>

        </div>

    </div>

    <div class="space-18"></div>
    <div class="row-fluid">

        <div class="tabbable" style="background-color: rgba(255,255,255,.7)">
            <ul class="nav nav-tabs">
                <li class="active">
                    <a data-toggle="tab" href="#overview-tab">
                        <i class="green icon-list-alt bigger-120"></i>
                        Overview
                    </a>
                </li>

                <li class="">
                    <a data-toggle="tab" href="#calendar-tab">
                        <i class="orange icon-calendar bigger-120"></i>
                        Calendar
                    </a>
                </li>

                <li class="">
                    <a data-toggle="tab" href="#description-tab">
                        <i class="blue icon-file bigger-120"></i>
                        Description
                    </a>
                </li>
            </ul>

            <div class="tab-content no-border no-padding">
                <div class="space-24"></div>
                <div id="overview-tab"
                     class="tab-pane in active">


                    <form id="add_note_form">

                        <div class="form-actions input-append">
                            <div class="itemdiv span1">
                                <div class="user">
                                    <img alt=""
                                         src="{%- if logged_in_user.thumbnail -%}/{{ logged_in_user.thumbnail.full_path }}{%- else -%}{{ request.static_url("stalker_pyramid:static/stalker/images/Placeholder_0.png") }}{%- endif -%}"/>
                                </div>
                            </div>
                            <div class="span11">
                                <input placeholder="Type your message here ..."
                                       type="text" class="width-90"
                                       name="message"/>
                                <button id="add_note_button"
                                        class="btn btn-small btn-info no-radius">
                                    <i class="icon-share-alt"></i>
                                    <span class="hidden-phone">Send</span>
                                </button>
                            </div>
                        </div>
                    </form>

                    {% include 'note/list/list_notes.jinja2' %}

                </div>
                <!--#overview-tab-->

                <div id="calendar-tab" class="tab-pane">

                    <div id="calendar"></div>

                </div>
                <div id="description-tab"
                     class="tab-pane">
                    <div class="offset1 span10">
                    {{ entity.description | safe }}
                        </div>
                </div>
                <!--/#calendar-tab-->
            </div>
        </div>

    </div>

    </div>

    <div class="span4">
        <div class="entityview-item clearfix">
            <div class="row-fluid">

                {% include 'review/view/review_card.jinja2' %}

            </div>

            <div class="space-4"></div>


            <div class="row-fluid">
                <div id="resources_box"
                     class="widget-box  transparent">
                    <div class="widget-header widget-header-small">
                        <h4 class="smaller grey"><i
                                class="icon-user orange"></i>Resources</h4>
                    </div>
                    <div class="widget-body">
                        <div class="widget-main">
                            <div id="resource_tree"
                                 class="tree"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="space-4"></div>


            <div class="row-fluid">
                <div id="version_used_by_tasks"
                     class="widget-box  transparent">
                    <div class="widget-header  widget-header-small">
                        <h4 class="smaller"><i
                                class="icon-long-arrow-down"></i>Versions are
                            used in
                        </h4>
                    </div>
                    <div class="widget-body">
                        <div class="widget-main">
                            <div id="version_used_by_tasks_tree"
                                 class="tree"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="space-4"></div>


            <div class="row-fluid">
                <div id="depends_box"
                     class="span6 widget-box transparent">
                    <div class="widget-header widget-header-small header-color-grey">
                        <h4 class="smaller"><i
                                class="icon-long-arrow-left"></i>Depends
                        </h4>
                    </div>
                    <div class="widget-body">
                        <div class="widget-main">
                            <div id="depends_tree"
                                 class="tree"></div>
                        </div>
                    </div>
                </div>

                <div id="dependent_of_box"
                     class="span6 widget-box transparent">
                    <div class="widget-header widget-header-small header-color-grey">
                        <h4 class="smaller">Dependent Of <i
                                class="icon-long-arrow-right"></i></h4>
                    </div>
                    <div class="widget-body">
                        <div class="widget-main">
                            <div id="dependent_of_tree"
                                 class="tree"></div>
                        </div>
                    </div>
                </div>

            </div>


        </div>
    </div>
    </div>
    </div>

    </div>

    </div>
    </div>
{% endblock page_content %}

{#EXTRA-SCRIPTS#}
{% block extrascripts %}



    {% if entity.children | count == 0 %}
        {% if has_permission('Update_User') and has_permission('Update_Task') %}
            {% set event_type='TimeLog' %}
        {% endif %}
    {% endif %}

    {% include 'charts/chart_extrascripts.jinja2' %}
    {% include 'charts/pie_chart.jinja2' %}
    {% include 'components/tree.jinja2' %}
    {% include 'calendar/calendar.jinja2' %}

    <script type="text/javascript">
        // convert all dates to moment
        $('.date').each(function () {
            var date = moment.utc($(this).text());
            $(this).text(date.fromNow());
        });
    </script>


    <script type="text/javascript">


        $(document).ready(function () {


            $('#add_note_button').on('click', function (e) {
                e.stopPropagation();
                e.preventDefault();

                // disable the submit_button
                var submit_button = $(this);
                submit_button.button('loading');

                var add_note_form = $('#add_note_form');


                $.post(
                                "/entities/{{ entity.id }}/note/create",
                                add_note_form.serialize()
                        ).done(function () {
                            window.location.assign('{{ came_from }}');
                        }).fail(function (jqXHR) {
                            bootbox.alert('<div id="message" class="alert alert-danger bigger-110">' + jqXHR.responseText + '</div>');
                            submit_button.button('reset');
                        });
            })


        });


        $(document).ready(function () {

            $.getJSON('/tasks/{{ entity.id }}/events/').then(function (data) {
                var events = [];
                var resources = new Object();

                for (var i = 0; i < data.length; i++) {
                    var start_date = new Date(parseInt(data[i].start));
                    var end_date = new Date(parseInt(data[i].end));
                    var title = data[i].title;

                    if (data[i].entity_type == 'tasks') {
                        for (var k = 0; k < data[i].resources.length; k++) {
                            var prop_id = (data[i].resources[k].id).toString();
                            title += ' - ' + data[i].resources[k].name;

                            if (!resources [prop_id]) {
                                resources [prop_id] = {
                                    'name': '<span><a href="/users/' + data[i].resources[k].id + '/view">' + data[i].resources[k].name + '  </a></span>',
                                    'type': 'folder',
                                    'icon-class': 'blue'
                                }
                            }

                            if (!resources[prop_id]['additionalParameters']) {
                                resources[prop_id]['additionalParameters'] = new Object();
                                resources[prop_id]['additionalParameters']['children'] = new Object();
                            }

                            var hours_to_complete = (data[i].schedule_seconds - data[i].total_logged_seconds) / 3600;
                            var hour_to_complete_str = '';

                            if (hours_to_complete > 0) {
                                hour_to_complete_str = '<span> ( ' + hours_to_complete + ' h )</span>'
                            }

                            var percent_complete_str = '<span class="label label-' + data[i].status_color + '">' + data[i].status + '</span>';

                            resources[prop_id]['additionalParameters']['children'][(data[i].id).toString()] = {name: '<span  class="pull-left"><a href="/tasks/' + data[i].id + '/view">' + data[i].title + '  </a></span>' + hour_to_complete_str + percent_complete_str, type: 'item'}

                            $('#resources_box').show();
                        }
                    }

                    if (data[i].resource_name) {
                        title = data[i].title + ' - ' + data[i].resource_name;
                    }

                    var event = {
                        eId: data[i].id,
                        entity_type: data[i].entity_type,
                        title: title,
                        start: start_date,
                        end: end_date,
                        className: data[i].className,
                        allDay: data[i].allDay
                    };
                    events.push(event);
                }

                drawCalendar('calendar', events);
                drawTree('resource_tree', resources);
            });
        });


        $(document).ready(function () {


            var get_dependency = function (type) {

                $.getJSON('/tasks/{{ entity.id }}/dependency/' + type + '/').then(function (data) {

                    var depends = new Object();
                    for (var i = 0; i < data.length; i++) {

                        var task_id = (data[i].id).toString();

                        var hours_to_complete = (data[i].schedule_seconds - data[i].total_logged_seconds) / 3600;
                        var hour_to_complete_str = '';

                        if (hours_to_complete > 0) {
                            hour_to_complete_str = '<span> ( ' + hours_to_complete + ' h )</span>'
                        }

                        var percent_complete_str = '<span class="label label-' + data[i].status_color + '">' + data[i].status + '</span>';


                        if (!depends[task_id]) {
                            depends[task_id] = {
                                'name': '<span><a href="/tasks/' + data[i].id + '/view">' + data[i].name + '  </a></span>' + hour_to_complete_str,
                                'type': 'folder',
                                'icon-class': data[i].status_color
                            }
                        }

                        if (!depends[task_id]['additionalParameters']) {
                            depends[task_id]['additionalParameters'] = new Object();
                            depends[task_id]['additionalParameters']['children'] = new Object();
                        }

                        for (var k = 0; k < data[i].resources.length; k++) {
                            depends[task_id]['additionalParameters']['children'][(data[i].resources[k].id).toString()] = {name: '<span  class="pull-left"><a href="/users/' + data[i].resources[k].id + '/view">' + data[i].resources[k].name + '  </a></span>', type: 'item'}
                        }

                    }

                    drawTree(type + '_tree', depends);

                    if (data.length == 0) {
                        $('#' + type + '_tree').append('<div class="alert alert-warning">No ' + type + ' for this task</div>');
                    }
                });
            }

            get_dependency('depends');
            get_dependency('dependent_of');
        });

        $(document).ready(function () {


            $.getJSON('/entities/{{ entity.id }}/version/used_by/tasks/').then(function (data) {

                console.log(data.length)

                var tasks = new Object();
                for (var i = 0; i < data.length; i++) {

                    var task_id = (data[i].id).toString();

                    if (!tasks[task_id]) {
                        tasks[task_id] = {
                            'name': '<span><a href="/tasks/' + data[i].id + '/view">' + data[i].name + '  </a></span>',
                            'type': 'folder',
                            'icon-class': data[i].status_color
                        }
                    }

                    if (!tasks[task_id]['additionalParameters']) {
                        tasks[task_id]['additionalParameters'] = new Object();
                        tasks[task_id]['additionalParameters']['children'] = new Object();
                    }

                    tasks[task_id]['additionalParameters']['children'][(data[i].resource_id).toString()] = {name: '<span  class="pull-left"><a href="/users/' + data[i].resource_id + '/view">' + data[i].resource_name + '  </a></span>', type: 'item'}


                }

                drawTree('version_used_by_tasks_tree', tasks);

                if (data.length == 0) {
                    $('#version_used_by_tasks_tree').append('<div class="alert alert-warning">No task used this task versions</div>');
                }
            });
        });

    </script>

{% endblock extrascripts %}
