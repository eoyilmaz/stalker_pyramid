

<link rel="stylesheet" href='{{ request.static_url("stalker_pyramid:static/ace/css/chosen.min.css") }}' />
<link rel="stylesheet" href='{{ request.static_url("stalker_pyramid:static/ace/css/datepicker.css") }}' />
<link rel="stylesheet" href='{{ request.static_url("stalker_pyramid:static/ace/css/bootstrap-timepicker.css") }}' />
<link rel="stylesheet" href='{{ request.static_url("stalker_pyramid:static/ace/css/daterangepicker.css") }}' />
<link rel="stylesheet" href='{{ request.static_url("stalker_pyramid:static/ace/css/colorpicker.css") }}' />

<div class='row-fluid'>
    <div class='span12'>

        <form id='task_form'
              class='form-horizontal'
              role='form'
              method='post'
              action="{{ request.route_url('create_task') }}">
            
            {# Entity Type #}
            <div class='control-group'>
                <label class='span3 control-label' for='task_entity_type'>Entity Type</label>
                <div class='span9'>
                    <select id='task_entity_type'
                            class='input-block-level'
                            name='task_entity_type'
                            data-placeholder='Entity Type'
                            required>
                        <option>Task</option>
                        <option>Asset</option>
                        <option>Shot</option>
                        <option>Sequence</option>
                    </select>
                </div>
            </div>

            {# Project #}
            <div class='control-group'>
                <label class='span3 control-label' for='task_project'>Project</label>
                <div class='span9'>
                    <select id='task_project'
                            class='input-block-level'
                            name='project_id'
                            data-placeholder='Project'
                            required></select>
                </div>
            </div>

            {# Parent #}
            <div class='control-group'>
                <label class='span3 control-label' for='task_parent'>Parent</label>
                <div class='span9'>
                    <select id='task_parent'
                            class='input-block-level'
                            name='task_parent_id'
                            data-placeholder='Parent'></select>
                </div>
            </div>

            {# Name #}
            <div class="control-group">
                <label class="span3 control-label" for="task_name">Name</label>
                <div class="span9">
                    <input id="task_name"
                           class='input-block-level'
                           name='name'
                           type="text"
                           class="form-control"
                           placeholder="Name"
                           required>
                </div>
            </div>

            {# Code #}
            <div class="control-group">
                <label class="span3 control-label" for="task_code">Code</label>
                <div class="span9">
                    <input id="task_code"
                           class='input-block-level'
                           name='code'
                           type="text"
                           class="form-control"
                           placeholder="Code"
                           required>
                </div>
            </div>

            {# Asset Type#}
            <div id='asset_inputs'>
                <div class='control-group'>
                    <label class='span3 control-label' for='asset_type'>Asset Type</label>
                    <div class='span9'>
                        <input id='asset_type'
                               class='input-block-level'
                               name='asset_type'
                               type='text'
                               class='form-control'
                               placeholder='Asset Type'>
                    </div>
                </div>
            </div>

            {# Shot Sequence #}
            <div class='shot_inputs'>
                <div class='control-group'>
                    <label class="span3 control-label" for='shot_sequence'>Sequence</label>
                    <div class='span9'>
                        <select id='shot_sequence'
                                class='input-block-level'
                                name='shot_sequence_id'
                                data-placeholder='Sequence'></select>
                    </div>
                </div>
            </div>

            {# Description #}
            <div class='control-group'>
                <label class='span3 control-label' for='task_description'>Descripion</label>
                <div class='span9'>
                    <textarea id="task_description"
                              name='description'
                              class="autosize-transition span12"
                              style="overflow: hidden;
                              word-wrap: break-word;
                              resize: horizontal;
                              height: 50px;"></textarea>
                </div>
            </div>

            {# Dependencies #}
            <div class='control-group'>
                <label class='span3 control-label' for='task_dependencies'>Dependencies</label>
                <div class='span9'>
                    <select id='task_dependencies'
                            class='input-block-level'
                            name='dependency_ids'
                            data-placeholder='Dependencies'></select>
                </div>
            </div>

            {# Resources #}
            <div class='control-group'>
                <label class='span3 control-label' for='task_resources'>Resources</label>
                <div class='span9'>
                    <select id='task_resources'
                            class='input-block-level'
                            name='resource_ids'
                            data-placeholder='Resources'></select>
                </div>
            </div>

            {# Responsible #}
            <div class='control-group'>
                <label class='span3 control-label' for='task_responsible'>Responsible</label>
                <div class='span9'>
                    <select id='task_responsible'
                            class='input-block-level'
                            name='responsible_id'
                            data-placeholder='Responsible'></select>
                </div>
            </div>

            {# Constraints #}
            
            {# Schedule Model / Effort / Length / Duration #}
            <div class='control-group'>
                <label class='span3 control-label' for='task_schedule_model'>Schedule Model</label>
                <div class='span9'>
                    <select id='task_schedule_model'
                            class='input-block-level'
                            name='schedule_model'>
                        <option value='effort'>Effort</option>
                        <option value='duration'>Duration</option>
                        <option value='length'>Length</option>
                    </select>
                </div>
            </div>

            {# Schedule Timing #}
            <div class='control-group'>
                <label class='span3 control-label' for='task_schedule_timing'>Schedule Timing</label>
                <div class='span9'>
                    <div class='span2'>
                        <input id='task_schedule_timing'
                               class='input-block-level'
                               name='schedule_timing'
                               type='text'
                               placeholder='FPS'
                               value=1
                               min=1
                               required>
                    </div>
                    <div class='span3'>
                        <select id='task_schedule_unit'
                               class='input-block-level'
                               name='schedule_unit'
                               val='Days'>
                            <option value='h'>Hours</option>
                            <option value='d'>Days</option>
                            <option value='w'>Weeks</option>
                            <option value='m'>Months</option>
                            <option value='y'>Years</option>
                        </select>
                    </div>
                </div>
            </div>
            
        </form>

    </div>
</div>

<script src='{{ request.static_url("stalker_pyramid:static/ace/js/chosen.jquery.min.js") }}'></script>
<script src='{{ request.static_url("stalker_pyramid:static/ace/js/date-time/bootstrap-datepicker.min.js") }}'></script>
<script src='{{ request.static_url("stalker_pyramid:static/ace/js/date-time/moment.min.js") }}'></script>
<script src='{{ request.static_url("stalker_pyramid:static/ace/js/date-time/daterangepicker.min.js") }}'></script>
<script src='{{ request.static_url("stalker_pyramid:static/ace/js/bootstrap-colorpicker.min.js") }}'></script>
<script src='{{ request.static_url("stalker_pyramid:static/ace/js/jquery.autosize-min.js") }}'></script>
<script src='{{ request.static_url("stalker_pyramid:static/ace/js/jquery.inputlimiter.1.3.1.min.js") }}'></script>
<script src='{{ request.static_url("stalker_pyramid:static/ace/js/jquery.maskedinput.min.js") }}'></script>
<script src='{{ request.static_url("stalker_pyramid:static/ace/js/bootstrap-tag.min.js") }}'></script>
<script src='{{ request.static_url("stalker_pyramid:static/ace/js/jquery.validate.min.js") }}'></script>
<script src='{{ request.static_url("stalker_pyramid:static/ace/js/additional-methods.min.js") }}'></script>
<script src='{{ request.static_url("stalker_pyramid:static/ace/js/fuelux/fuelux.spinner.min.js") }}'></script>


<script>
    function init_task_dialog(){
        console.debug('starting to initialize task dialog!!!');

        {# ***************************************************************** #}
        {# Entity Type #}
        // convert to chosen
        $('#task_entity_type').chosen({disable_search_threshold: 10});

        {# ***************************************************************** #}
        {# Projects #}
        {% raw %}
        var project_option_template = doT.template(
            '<option value={{=it.id}}>{{=it.name}}</option>'
        );
        {% endraw %}
        var task_project = $('#task_project');
        var deferred = chosen_field_creator(
                task_project, '/projects/',
                project_option_template,
                {search_contains: true}
        );

        var project_id;
        {% if mode == 'update' %}
            project_id = {{ task.project.id }};
            deferred.then(function(){
                task_project.val(project_id).trigger('chosen:updated');
            });
        {% endif %}

        {# ***************************************************************** #}
        {# Parent #}
        // create a chosen first
        var task_parent = $('#task_parent').chosen({search_contains: true});

        // update task_parent callback
        var update_task_parent = function(){
            // remove current elements
            task_parent.find('option').remove();

            // trigger an update
            task_parent.trigger('chosen:updated');

            // get the project id
            var project_id = task_project.val();

            // get tasks of that project as json from server
            $.getJSON('/projects/' + project_id + '/tasks/').then(function(data){
                // now append the data to the task_parent
                {% raw %}
                var task_parent_template = doT.template('<option value={{=it.id}}>{{=it.name}}</option>');
                {% endraw %}
                var parent_task_count = data.length;
                for (var i=0; i < parent_task_count; i++){
                    task_parent.append( task_parent_template(data[i]) );
                }
                // trigger another update
                task_parent.trigger('chosen:updated');
            });
        };

        // update now
        setTimeout(update_task_parent, 100); // TODO: This is not good

        // Update on project change
        task_project.on('change', update_task_parent);

        console.debug('finished initializing the task dialog!')
    }
</script>
