<div id="loading_spinner" class="well well-sm">

    <div class="inline middle blue bigger-110">
        <i class="icon-spinner icon-spin orange bigger-125"></i>
        Loading content...
    </div>
</div>

<div class="row-fluid">
    <table id="items_table"
           class="table table-striped table-bordered table-hover hide">
        <thead></thead>
        <tbody></tbody>
    </table>
</div>


<script src='{{ request.static_url("stalker_pyramid:static/ace/js/jquery.dataTables.min.js") }}'></script>
<script src='{{ request.static_url("stalker_pyramid:static/ace/js/jquery.dataTables.bootstrap.js") }}'></script>
<script src='{{ request.static_url("stalker_pyramid:static/stalker/js/dataTable_num-html_sort.js") }}'></script>


<script>
    function init_html_modal() {

        console.debug('starting to initialize init_html_modal dialog!!!{{ filter.code  }}');

        {% if filter.entity_type == 'Status' %}
            var template_label = $('#html_template_label');
            template_label.find('span').remove();
            {% if is_warning_list %}
                template_label.append('<span>Black List<small> !! these tasks should be sent to review or extra time should be requested for them !!</small></span>');
                $('#html_template_header').attr('class', 'table-header header-color-dark');
            {% else %}
                template_label.append('<span>{{ filter.name }}</span>');
                $('#html_template_header').attr('class', 'table-header header-color-' + '{{ filter.code.lower() }}');
            {% endif %}
        {% endif %}

        var query_str = '';

        {% if entity.entity_type == 'User' %}
            query_str = 'resource_id={{ entity.id }}';
        {% elif entity.entity_type == 'Project'%}
            query_str = 'project_id={{ entity.id }}';
        {% endif %}

        {% if filter.entity_type == 'User' %}
            query_str = 'responsible_id={{ filter.id }}';
        {% elif filter.entity_type == 'Status'%}
            query_str += '&status={{ filter.code }}';
        {% endif %}

        $.getJSON('/tasks/?has_resource=1&leaf_only=1&' + query_str).then(function (data) {

            // fill items table with dynamic data
            // wait until document is ready
            $(function () {
                var thead_template = doT.template($('#tmpl_itemThead').html());
                var table = $('#items_table');
                var table_head = table.find('thead');
                table_head.append(thead_template({}));

{#                var items = data;#}
                var row_template = doT.template($('#tmpl_itemRow').html());

                var i;
                var table_body = table.find('tbody');
                for (i = 0; i < data.length; i++) {
                    // fix dates
                    data[i].start = new Date(data[i].start).format('yyyy-mm-dd HH:MM');

                    if (data[i].thumbnail_full_path === null) {
                        data[i].thumbnail_full_path = '{{ request.static_url("stalker_pyramid:static/stalker/images/T_NO_IMAGE.gif") }}';
                    } else {
                        data[i].thumbnail_full_path = '/' + data[i].thumbnail_full_path;
                    }

                    for (var k=0; k<data[i].responsible.length;k++){
                        var r_id = data[i].responsible[k];
                        data[i].responsible[k] = {'id':r_id,
                                               'name':get_user_name(r_id)}

                    }


                    var bid_seconds = calculate_seconds(data[i].bid_timing, data[i].bid_unit);
                    data[i].hour_based_on_bid = meaningful_time_between(bid_seconds, data[i].total_logged_seconds);
                    data[i].hour_to_complete = meaningful_time_between(
                                                   calculate_seconds(
                                                       data[i].schedule_timing,
                                                       data[i].schedule_unit
                                                   ),
                                                   data[i].total_logged_seconds
                                               );

                    if(bid_seconds<data[i].total_logged_seconds){
                         data[i].bid_stat = '#ff0000'
                    }

                    var r, resources, responsible;
                    if(data[i].status === 'wip') {
                        resources = data[i].resources;
                        for(r = 0; r < resources.length; r++){
                            if(resources[r].id === {{ logged_in_user.id }} ){
                                data[i].request_review = "/tasks/" + data[i].id + "/request_review/dialog?came_from={{ request.current_route_path() }}&request_review_mode=Final";
                            }
                        }
                    }

                    if (data[i].status === 'prev') {
                        responsible = data[i].responsible;
                        for (r = 0; r < responsible.length; r++) {
                            if (responsible[r].id === {{ logged_in_user.id }}) {
                                data[i].review ="/tasks/" + data[i].id + "/review/dialog?came_from={{ request.current_route_path() }}";
                            }
                        }
                    }

                    if (data[i].status === 'wip' && data[i].completed == 100) {
                        resources = data[i].resources;
                        for (r = 0; r < resources.length; r++) {
                            if (resources[r].id === {{ logged_in_user.id }}) {
                                data[i].request_extra_time ="/tasks/" + data[i].id + "/request_extra_time/dialog?came_from={{ request.current_route_path() }}";
                            }
                        }
                    }

                    data[i].came_from = '{{ request.current_route_path() }}';

                    {% if has_permission('Create_Review') %}
                        if(data[i].hour_to_complete == 0){
                             data[i].poke_user = true;
                        }
                    {% endif %}

                    // append it to the table
                    {% if is_warning_list %}
                        if(data[i].hour_to_complete == 0){
                            table_body.append(row_template(data[i]));
                        }
                    {% else %}
                        table_body.append(row_template(data[i]));
                    {% endif %}
                }

                var oTable1 = table.dataTable();
                oTable1.show();
                $('#loading_spinner').hide();

             });
{#            });#}
        });

        console.debug('finished initializing the init_html_modal dialog!')
    }
</script>

<script type="text/javascript">
    function destruct_html_modal() {
        $('#items_table').unbind();
        $('#html_template').data('modal', null);
    }
</script>
